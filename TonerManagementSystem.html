<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portable Toner Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñ®Ô∏è</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        /* Base Variables - Wuerth Theme */
        :root {
            --primary-color: #E4002B; /* Wuerth Red */
            --secondary-color: #C00020; /* Darker Red */
            --accent-color: #F0F0F0; /* Light Gray for accents */
            --dark-color: #333333; /* Dark text */
            --light-color: #FFFFFF; /* Light background */
            --success-color: #4CAF50; /* Green */
            --danger-color: #F44336; /* Red */
            --warning-color: #FFC107; /* Amber */
            --info-color: #2196F3; /* Blue */
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --card-bg: #ffffff;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        /* Universal Box-sizing */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--accent-color) 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 15px;
            line-height: 1.6;
            color: var(--dark-color);
        }

        /* App Container */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* App Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        }

        .app-header h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .app-header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .version-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }

        /* Fixed layout structure */
        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Navigation */
        .nav-container {
            background: white;
            border-right: 1px solid #dee2e6;
            width: 250px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .nav-tabs {
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .nav-tab {
            padding: 15px 25px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: var(--transition);
            position: relative;
            white-space: nowrap;
            border-left: 3px solid transparent;
        }

        .nav-tab.active {
            color: var(--primary-color);
            background: rgba(228, 0, 43, 0.05); /* Lighter shade of Wuerth Red */
            border-left-color: var(--primary-color);
        }

        .nav-tab:hover:not(.active) {
            color: var(--primary-color);
            background: rgba(228, 0, 43, 0.03);
        }

        .nav-tab i {
            margin-right: 10px;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 25px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Component */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .card-title {
            color: var(--dark-color);
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0 0 10px 0;
        }

        .card-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
            margin: 0;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .form-control {
            padding: 14px 16px;
            border: 2px solid #e1e5e8;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(228, 0, 43, 0.1);
        }
        
        .form-control.invalid {
            border-color: var(--danger-color);
        }

        /* Multi-select specific styling */
        .form-control[multiple] {
            height: auto;
            min-height: 150px; /* Adjust as needed */
            padding: 10px;
        }
        .form-control[multiple] option {
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: pointer;
        }
        .form-control[multiple] option:checked {
            background-color: var(--primary-color);
            color: white;
        }


        /* Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(228, 0, 43, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #43A047;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #D32F2F;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color); /* Use primary color for stat card border */
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(228, 0, 43, 0.05) 100%);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Department Grid */
        .department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .department-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .department-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(228, 0, 43, 0.05) 100%);
            opacity: 0;
            transition: var(--transition);
        }

        .department-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .department-card:hover::before {
            opacity: 1;
        }

        .department-card h3 {
            color: var(--dark-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            position: relative;
            z-index: 1;
        }

        .department-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .dept-stat {
            text-align: center;
            padding: 12px;
            background: var(--accent-color); /* Use accent for light background */
            border-radius: 8px;
        }

        .dept-stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .dept-stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: var(--accent-color); /* Use accent for table headers */
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: alertSlideIn 0.3s ease;
        }

        @keyframes alertSlideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .alert-error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--danger-color);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            display: none;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Backup Section */
        .backup-section {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .backup-section p {
            color: #856404;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* Charts */
        .chart-container {
            height: 320px;
            width: 100%;
            margin-bottom: 30px;
        }
        .chart-container-with-export {
            position: relative;
        }
        .chart-export-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            transition: background 0.3s ease;
        }
        .chart-export-btn:hover {
            background: rgba(0,0,0,0.2);
        }
        .chart-export-btn.xlsx {
            right: 120px; /* Adjust position for XLSX button */
            background: rgba(40, 167, 69, 0.7); /* Greenish for XLSX */
        }
        .chart-export-btn.xlsx:hover {
            background: rgba(40, 167, 69, 0.9);
        }


        /* Filter Group */
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-group .form-group {
            flex: 1;
            min-width: 200px;
        }

        /* System Info */
        .system-info-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .system-info-item:last-child {
            border-bottom: none;
        }

        /* Loading Indicator */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Keyboard Shortcuts */
        .keyboard-shortcuts {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .shortcut-keys {
            font-family: monospace;
            font-weight: bold;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            color: var(--dark-color);
        }

        .shortcut-action {
            color: var(--dark-color);
        }

        /* Validation Messages */
        .validation-message {
            font-size: 0.8rem;
            margin-top: 5px;
            color: var(--danger-color);
            display: none;
        }

        .form-group.has-error .validation-message {
            display: block;
        }

        /* New Elements (Switch, Icon Buttons, Action Cells) */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .slider.round {
            border-radius: 34px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            margin: 0 5px;
            color: var(--dark-color);
            transition: all 0.2s ease;
        }
        
        .btn-icon:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .action-cell {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        /* Overview Lists */
        .overview-list {
            list-style: none;
            padding: 0;
        }

        .overview-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #e9ecef;
            font-size: 0.95rem;
            color: var(--dark-color);
        }

        .overview-list li:last-child {
            border-bottom: none;
        }

        .overview-list li strong {
            color: var(--primary-color);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .nav-container {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .app-header {
                padding: 20px 15px;
            }

            .app-header h1 {
                font-size: 2rem;
            }

            .app-body {
                flex-direction: column;
            }
            
            .nav-container {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .nav-tabs {
                flex-direction: row;
                overflow-x: auto;
                padding: 10px 0;
            }

            .nav-tab {
                padding: 10px 15px;
                white-space: nowrap;
            }

            .main-content {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .department-stats {
                grid-template-columns: 1fr;
            }

            .shortcuts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .app-container {
                box-shadow: none;
                border-radius: 0;
            }

            .nav-container,
            .btn,
            .modal,
            .chart-export-btn {
                display: none !important;
            }

            .tab-content {
                display: block !important;
                padding: 20px;
            }

            .data-table {
                box-shadow: none;
            }
        }

        /* Dark mode support */
        body.dark-mode {
            --light-color: #121212;
            --card-bg: #1e1e1e;
            --dark-color: #e0e0e0;
            --success-color: #66bb6a;
            --danger-color: #ef5350;
            --warning-color: #ffb74d;
            --info-color: #42a5f5;
            --box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .app-container {
            background: #1e1e1e;
        }
        
        body.dark-mode .card {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }
        
        body.dark-mode .card-header {
            border-bottom-color: #3a3a3a;
        }
        
        body.dark-mode .data-table {
            background: #2a2a2a;
        }
        
        body.dark-mode .data-table th {
            background: #3a3a3a;
        }
        
        body.dark-mode .empty-state {
            color: #b0b0b0;
        }
        
        body.dark-mode .empty-state h3 {
            color: #e0e0e0;
        }
        
        body.dark-mode .low-stock {
            border-left-color: #ffc107;
        }
        
        body.dark-mode .low-stock .inventory-quantity {
            color: #ffc107;
        }
        
        body.dark-mode .low-stock .progress-bar {
            background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
        }
        
        body.dark-mode .alert-success {
            background: #3a5a40;
            color: #bdecb6;
            border-color: #2d4333;
        }
        
        body.dark-mode .alert-error {
            background: #6d1c14;
            color: #fbc4c4;
            border-color: #5a1714;
        }
        
        body.dark-mode .alert-info {
            background: #133f47;
            color: #b3e0e8;
            border-color: #133f47;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="version-badge">v2.9 XLSX Export & Enhanced Auto-Backup</div>
            <h1>üñ®Ô∏è Toner Management System</h1>
            <p class="subtitle">Portable ‚Ä¢ Offline ‚Ä¢ Cross-Platform</p>
        </div>
        
        <div class="app-body">
            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="tonerApp.switchTab('add-entry')" data-tab-id="add-entry">
                        <i>üìù</i> Add Entry
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('dashboard')" data-tab-id="dashboard">
                        <i>üìä</i> Dashboard
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('analytics')" data-tab-id="analytics">
                        <i>üìà</i> Analytics
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('all-entries')" data-tab-id="all-entries">
                        <i>üìã</i> All Entries
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('master-data')" data-tab-id="master-data">
                        <i>üóÉÔ∏è</i> Master Data
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('reports')" data-tab-id="reports">
                        <i>üìÑ</i> Reports
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('backup')" data-tab-id="backup">
                        <i>üíæ</i> Backup
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('audit-log')" data-tab-id="audit-log">
                        <i>üìú</i> Audit Log
                    </button>
                    <button class="nav-tab" onclick="tonerApp.switchTab('settings')" data-tab-id="settings">
                        <i>‚öôÔ∏è</i> Settings
                    </button>
                </div>
            </div>

            <div class="main-content">
                <div id="add-entry" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Add New Toner Purchase</h2>
                            <p class="card-subtitle">Track your toner purchases with detailed information</p>
                        </div>
                        <div id="alert-container"></div>
                        
                        <div class="keyboard-shortcuts">
                            <h4>Quick Shortcuts</h4>
                            <div class="shortcuts-grid">
                                <div class="shortcut-item">
                                    <div class="shortcut-keys">Ctrl/Cmd + S</div>
                                    <div class="shortcut-action">Save Entry</div>
                                </div>
                                <div class="shortcut-item">
                                    <div class="shortcut-keys">Ctrl/Cmd + N</div>
                                    <div class="shortcut-action">New Form</div>
                                </div>
                                <div class="shortcut-item">
                                    <div class="shortcut-keys">Ctrl/Cmd + B</div>
                                    <div class="shortcut-action">Backup Data</div>
                                </div>
                                <div class="shortcut-item">
                                    <div class="shortcut-keys">Ctrl/Cmd + E</div>
                                    <div class="shortcut-action">Export Data</div>
                                </div>
                            </div>
                        </div>

                        <form id="toner-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="department">Department *</label>
                                    <select id="department" class="form-control" required>
                                        <option value="">Select Department</option>
                                        </select>
                                    <div class="validation-message">Please select a department</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="toner-model">Toner Model *</label>
                                    <select id="toner-model" class="form-control" required>
                                        <option value="">Select Toner Model</option>
                                    </select>
                                    <div class="validation-message">Please select a toner model</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="date">Purchase Date *</label>
                                    <input type="date" id="date" class="form-control" required>
                                    <div class="validation-message">Please select a valid date</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="invoice">Invoice Number *</label>
                                    <input type="text" id="invoice" class="form-control" placeholder="Enter invoice number" required>
                                    <div class="validation-message">Please enter a valid invoice number</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="supplier">Supplier Name *</label>
                                    <select id="supplier" class="form-control" required>
                                        <option value="">Select Supplier</option>
                                    </select>
                                    <div class="validation-message">Please select a supplier</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="price">Unit Price (AED) *</label>
                                    <input type="number" id="price" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                                    <div class="validation-message">Price must be greater than 0</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="quantity">Quantity *</label>
                                    <input type="number" id="quantity" class="form-control" min="1" placeholder="Enter quantity" required>
                                    <div class="validation-message">Quantity must be greater than 0</div>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label" for="comments">Comments (Optional)</label>
                                    <textarea id="comments" class="form-control" rows="3" placeholder="Add any relevant comments..."></textarea>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">
                                    <span>‚ûï Add Toner Entry</span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="tonerApp.clearForm()">
                                    <span>üóëÔ∏è Clear Form</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="dashboard" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-icon">üìä</span>
                            <div class="stat-value" id="total-entries">0</div>
                            <div class="stat-label">Total Entries</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üè¢</span>
                            <div class="stat-value" id="total-departments">0</div>
                            <div class="stat-label">Departments</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üí∞</span>
                            <div class="stat-value" id="total-spent">AED 0</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon">üì¶</span>
                            <div class="stat-value" id="total-quantity">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Top 5 Departments by Spending</h2>
                        </div>
                        <div id="top-departments-spending">
                            <ul class="overview-list">
                            </ul>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Top 5 Toner Models by Quantity</h2>
                        </div>
                        <div id="top-toner-models">
                            <ul class="overview-list">
                            </ul>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Key Financial Overviews</h2>
                        </div>
                        <div class="form-grid">
                            <div class="stat-card" style="border-left-color: var(--success-color);">
                                <span class="stat-icon">üí∏</span>
                                <div class="stat-value" id="highest-spending-supplier">AED 0</div>
                                <div class="stat-label">Highest Spending Supplier</div>
                            </div>
                            <div class="stat-card" style="border-left-color: var(--info-color);">
                                <span class="stat-icon">üè∑Ô∏è</span>
                                <div class="stat-value" id="overall-avg-price">AED 0</div>
                                <div class="stat-label">Overall Avg. Toner Price</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Department Consumption Details</h2>
                            <p class="card-subtitle">Detailed breakdown of toner consumption per department.</p>
                        </div>
                        <div class="filter-group" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="filter-consumption-year">Year</label>
                                <select id="filter-consumption-year" class="form-control" onchange="tonerApp.applyConsumptionFilters()">
                                    <option value="">All Years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="filter-consumption-month">Month</label>
                                <select id="filter-consumption-month" class="form-control" onchange="tonerApp.applyConsumptionFilters()">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                        </div>
                        <div id="department-consumption-details">
                            </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Purchases</h2>
                        </div>
                        <div class="filter-group" style="margin-top: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="search-recent">Search Purchases</label>
                                <input type="text" id="search-recent" class="form-control" placeholder="Search department, model, supplier..." oninput="tonerApp.filterRecentPurchases()">
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Department</th>
                                    <th>Date</th>
                                    <th>Toner Model</th>
                                    <th>Supplier</th>
                                    <th>Quantity</th>
                                    <th>Total Cost</th>
                                    <th>VAT (5%)</th>
                                    <th>Total (incl. VAT)</th>
                                    <th>Comments</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-purchases">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="analytics" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Department Spending Trends</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="departmentSpendingTrendsChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Toner Consumption by Department</h2>
                        </div>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="tonerConsumptionByDepartmentChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Monthly Consumption Trends</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyConsumptionTrendsChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Department-wise Comparison</h2>
                            <p class="card-subtitle">Total Spending vs. Total Quantity by Department</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="departmentWiseComparisonChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Predictive Analysis: Future Consumption</h2>
                            <p class="card-subtitle">Projected toner consumption based on historical data.</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="predictiveAnalysisChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Departments with Highest Average Purchase Value</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="departmentAvgPurchaseValueChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Department Purchase Frequency</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="departmentPurchaseFrequencyChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Supplier Average Unit Price Comparison</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="supplierAvgUnitPriceChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Supplier Performance Overview</h2>
                            <p class="card-subtitle">Analyze spending and quantity from each supplier.</p>
                        </div>
                        <div id="supplier-performance-overview">
                        </div>
                    </div>
                </div>

                <div id="all-entries" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">All Toner Entries</h2>
                            <p class="card-subtitle">View, filter, and manage all recorded toner purchases.</p>
                        </div>
                        <div class="filter-group" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="filter-all-department">Filter by Department</label>
                                <select id="filter-all-department" class="form-control" onchange="tonerApp.filterAllEntries()">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="search-all-entries">Search All Entries</label>
                                <input type="text" id="search-all-entries" class="form-control" placeholder="Search by model, invoice, supplier..." oninput="tonerApp.filterAllEntries()">
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Department</th>
                                    <th>Date</th>
                                    <th>Toner Model</th>
                                    <th>Invoice #</th>
                                    <th>Supplier</th>
                                    <th>Unit Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>VAT (5%)</th>
                                    <th>Total (incl. VAT)</th>
                                    <th>Comments</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-entries-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="master-data" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Manage Departments</h2>
                            <p class="card-subtitle">Add, edit, or remove departments for better organization.</p>
                        </div>
                        <div class="filter-group" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="search-departments">Search Departments</label>
                                <input type="text" id="search-departments" class="form-control" placeholder="Search department name..." oninput="tonerApp.renderDepartmentsList()">
                            </div>
                        </div>
                        <div class="btn-group" style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="tonerApp.openAddDepartmentModal()">
                                <span>‚ûï Add New Department</span>
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Department Name</th>
                                    <th>Default Toner Model(s)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="departments-list-body">
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Manage Toner Models</h2>
                            <p class="card-subtitle">Add, edit, or remove toner models available in your inventory.</p>
                        </div>
                        <div class="filter-group" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="search-toner-models">Search Toner Models</label>
                                <input type="text" id="search-toner-models" class="form-control" placeholder="Search model name or type..." oninput="tonerApp.renderTonerModelsList()">
                            </div>
                        </div>
                        <div class="btn-group" style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="tonerApp.openAddTonerModelModal()">
                                <span>‚ûï Add New Toner Model</span>
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Model Name</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="toner-models-list-body">
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Manage Suppliers</h2>
                            <p class="card-subtitle">Add, edit, or remove toner suppliers.</p>
                        </div>
                        <div class="filter-group" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="search-suppliers">Search Suppliers</label>
                                <input type="text" id="search-suppliers" class="form-control" placeholder="Search supplier name or contact..." oninput="tonerApp.renderSuppliersList()">
                            </div>
                        </div>
                        <div class="btn-group" style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="tonerApp.openAddSupplierModal()">
                                <span>‚ûï Add New Supplier</span>
                            </button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Supplier Name</th>
                                    <th>Contact Info</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="suppliers-list-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="reports" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">General Reports</h2>
                        </div>
                        <div class="btn-group" style="margin-bottom: 30px;">
                            <button class="btn btn-success" onclick="tonerApp.exportAllData()">
                                <span>üìÑ Export All Data (JSON)</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.exportAllDataXLSX()">
                                <span>üìä Export All Data (XLSX)</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.exportDepartmentSummary()">
                                <span>üìä Export Department Summary (CSV)</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.exportTonerModelUsageReport()">
                                <span>üñ®Ô∏è Toner Model Usage (CSV)</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.exportSupplierPurchaseHistory()">
                                <span>üì¶ Supplier Purchase History (CSV)</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.exportMonthlySpendingReport()">
                                <span>üìà Monthly Spending (CSV)</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.printReport()">
                                <span>üñ®Ô∏è Print Current View</span>
                            </button>
                            <button class="btn btn-success" onclick="tonerApp.exportPDF()">
                                <span>üìÑ Export to PDF</span>
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Department-wise Export</h3>
                            <p class="card-subtitle">Export data for a specific department or multiple departments.</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="export-department-select">Select Department(s)</label>
                                <select id="export-department-select" class="form-control" multiple size="5">
                                    </select>
                                <small style="color: #6c757d; margin-top: 5px;">
                                    Hold Ctrl/Cmd to select multiple.
                                </small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Export Type</label>
                                <select id="export-type-select" class="form-control">
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                    <option value="xlsx">XLSX</option>
                                    <option value="pdf">PDF</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="tonerApp.exportDepartmentData()">
                                <span>‚¨áÔ∏è Export Department Data</span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Toner Model Usage Overview</h2>
                        </div>
                        <div class="chart-container chart-container-with-export">
                            <canvas id="tonerModelUsageChart"></canvas>
                            <button class="btn chart-export-btn" onclick="tonerApp.exportChartAsPNG('tonerModelUsageChart', 'toner_model_usage_chart.png')">Export as PNG</button>
                            <button class="btn chart-export-btn xlsx" onclick="tonerApp.exportTonerModelUsageChartData()">Export Data as XLSX</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Supplier Spending Distribution</h2>
                        </div>
                        <div class="chart-container chart-container-with-export">
                            <canvas id="supplierSpendingDistributionChart"></canvas>
                            <button class="btn chart-export-btn" onclick="tonerApp.exportChartAsPNG('supplierSpendingDistributionChart', 'supplier_spending_distribution_chart.png')">Export as PNG</button>
                            <button class="btn chart-export-btn xlsx" onclick="tonerApp.exportSupplierSpendingDistributionChartData()">Export Data as XLSX</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Monthly Spending Trends</h2>
                        </div>
                        <div class="chart-container chart-container-with-export">
                            <canvas id="monthlySpendingChart"></canvas>
                            <button class="btn chart-export-btn" onclick="tonerApp.exportChartAsPNG('monthlySpendingChart', 'monthly_spending_chart.png')">Export as PNG</button>
                            <button class="btn chart-export-btn xlsx" onclick="tonerApp.exportMonthlySpendingChartData()">Export Data as XLSX</button>
                        </div>
                    </div>

                </div>

                <div id="backup" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Data Backup & Restore</h2>
                            <p class="card-subtitle">Secure your data by creating backups or restoring from previous ones.</p>
                        </div>
                        <div class="backup-section">
                            <h4>Important:</h4>
                            <p>For data integrity, always download a backup before importing. This ensures you have a recovery point in case of issues with the imported file.</p>
                            <p>Last Auto-Backup: <span id="last-auto-backup-timestamp">N/A</span></p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="tonerApp.exportJsonData()">
                                <span>üíæ Export Data (JSON)</span>
                            </button>
                            <label for="import-json" class="btn btn-primary">
                                <span>‚¨ÜÔ∏è Import Data (JSON)</span>
                                <input type="file" id="import-json" accept=".json" style="display: none;" onchange="tonerApp.importJsonData(event)">
                            </label>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Bulk Import Data</h2>
                            <p class="card-subtitle">Import multiple entries or departments from a CSV or XLSX file.</p>
                        </div>
                        <div class="btn-group" style="margin-bottom: 20px;">
                            <label for="import-entries-file" class="btn btn-primary">
                                <span>‚¨ÜÔ∏è Import Entries (CSV/XLSX)</span>
                                <input type="file" id="import-entries-file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;" onchange="tonerApp.importBulkData(event, 'entries')">
                            </label>
                            <label for="import-departments-file" class="btn btn-primary">
                                <span>‚¨ÜÔ∏è Import Departments (CSV/XLSX)</span>
                                <input type="file" id="import-departments-file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;" onchange="tonerApp.importBulkData(event, 'departments')">
                            </label>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="tonerApp.downloadSampleEntriesCsv()">
                                <span>‚¨áÔ∏è Sample Entries (CSV)</span>
                            </button>
                            <button class="btn btn-secondary" onclick="tonerApp.downloadSampleEntriesXLSX()">
                                <span>‚¨áÔ∏è Sample Entries (XLSX)</span>
                            </button>
                            <button class="btn btn-secondary" onclick="tonerApp.downloadSampleDepartmentsCsv()">
                                <span>‚¨áÔ∏è Sample Departments (CSV)</span>
                            </button>
                            <button class="btn btn-secondary" onclick="tonerApp.downloadSampleDepartmentsXLSX()">
                                <span>‚¨áÔ∏è Sample Departments (XLSX)</span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Auto Backup Settings</h2>
                            <p class="card-subtitle">Configure automatic data backups to your local storage.</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="auto-backup-toggle">Enable Auto Backup (Every 1 Hour)</label>
                            <label class="switch">
                                <input type="checkbox" id="auto-backup-toggle" onchange="tonerApp.toggleAutoBackup()">
                                <span class="slider round"></span>
                            </label>
                            <small style="color: #6c757d; margin-top: 10px;">
                                When enabled, data will be automatically backed up every hour and overwrite the previous auto-backup.
                            </small>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" for="backup-location-path">Preferred Backup Directory (for reference)</label>
                            <input type="text" id="backup-location-path" class="form-control" placeholder="e.g., C:\Users\YourName\Documents\TonerBackups" oninput="tonerApp.updateBackupLocation()">
                            <small style="color: #6c757d; margin-top: 10px;">
                                This field is for your reference only. The actual download location is managed by your browser.
                            </small>
                        </div>
                    </div>
                </div>

                <div id="audit-log" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">System Audit Log</h2>
                            <p class="card-subtitle">Review all actions performed within the system.</p>
                        </div>
                        <div class="filter-group" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label" for="filter-log-type">Filter by Type</label>
                                <select id="filter-log-type" class="form-control" onchange="tonerApp.renderAuditLog()">
                                    <option value="">All Types</option>
                                    <option value="add">Add</option>
                                    <option value="edit">Edit</moption>
                                    <option value="delete">Delete</moption>
                                    <option value="backup">Backup</option>
                                    <option value="restore">Restore</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="search-audit-log">Search Log</label>
                                <input type="text" id="search-audit-log" class="form-control" placeholder="Search message..." oninput="tonerApp.renderAuditLog()">
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Type</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody id="audit-log-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="settings" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Application Settings</h2>
                            <p class="card-subtitle">Customize your Toner Management System experience.</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="dark-mode-toggle">Dark Mode</label>
                            <label class="switch">
                                <input type="checkbox" id="dark-mode-toggle" onchange="tonerApp.toggleDarkMode()">
                                <span class="slider round"></span>
                            </label>
                            <small style="color: #6c757d; margin-top: 10px;">
                                Switch between light and dark themes.
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="vat-rate-input">VAT Rate (%)</label>
                            <input type="number" id="vat-rate-input" class="form-control" step="0.1" min="0" max="100" value="5" onchange="tonerApp.updateVatRate()">
                            <small style="color: #6c757d; margin-top: 10px;">
                                Set the default VAT rate for calculations (e.g., 5 for 5%).
                            </small>
                        </div>
                        <div class="btn-group" style="margin-top: 20px;">
                            <button class="btn btn-danger" onclick="tonerApp.clearAllData()">
                                <span>‚ö†Ô∏è Clear All Data</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Toner Entry</h2>
                <span class="modal-close" onclick="tonerApp.closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-toner-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="edit-department">Department *</label>
                            <select id="edit-department" class="form-control" required>
                                <option value="">Select Department</option>
                            </select>
                            <div class="validation-message">Please select a department</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-toner-model">Toner Model *</label>
                            <select id="edit-toner-model" class="form-control" required>
                                <option value="">Select Toner Model</option>
                            </select>
                            <div class="validation-message">Please select a toner model</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-date">Purchase Date *</label>
                            <input type="date" id="edit-date" class="form-control" required>
                            <div class="validation-message">Please select a valid date</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-invoice">Invoice Number *</label>
                            <input type="text" id="edit-invoice" class="form-control" placeholder="Enter invoice number" required>
                            <div class="validation-message">Please enter a valid invoice number</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-supplier">Supplier Name *</label>
                            <select id="edit-supplier" class="form-control" required>
                                <option value="">Select Supplier</option>
                            </select>
                            <div class="validation-message">Please select a supplier</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-price">Unit Price (AED) *</label>
                            <input type="number" id="edit-price" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                            <div class="validation-message">Price must be greater than 0</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-quantity">Quantity *</label>
                            <input type="number" id="edit-quantity" class="form-control" min="1" placeholder="Enter quantity" required>
                            <div class="validation-message">Quantity must be greater than 0</div>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label" for="edit-comments">Comments (Optional)</label>
                            <textarea id="edit-comments" class="form-control" rows="3" placeholder="Add any relevant comments..."></textarea>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ Save Changes</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="tonerApp.closeEditModal()">
                            <span>‚úñÔ∏è Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="addDepartmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Department</h2>
                <span class="modal-close" onclick="tonerApp.closeAddDepartmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-department-form">
                    <div class="form-group">
                        <label class="form-label" for="new-department-name">Department Name *</label>
                        <input type="text" id="new-department-name" class="form-control" placeholder="e.g., IT Department" required>
                        <div class="validation-message">Please enter a department name</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="default-toner-model">Default Toner Model (Optional)</label>
                        <input type="text" id="default-toner-model" class="form-control" placeholder="e.g., TN-3417, CK-4520 (comma-separated)">
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span>‚ûï Add Department</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="addTonerModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Toner Model</h2>
                <span class="modal-close" onclick="tonerApp.closeAddTonerModelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-toner-model-form">
                    <div class="form-group">
                        <label class="form-label" for="new-toner-model-name">Toner Model Name *</label>
                        <input type="text" id="new-toner-model-name" class="form-control" placeholder="e.g., TN-3417" required>
                        <div class="validation-message">Please enter a toner model name</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-toner-model-type">Type (Optional)</label>
                        <input type="text" id="new-toner-model-type" class="form-control" placeholder="e.g., Black, Cyan, Magenta, Yellow">
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span>‚ûï Add Toner Model</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="editTonerModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Toner Model</h2>
                <span class="modal-close" onclick="tonerApp.closeEditTonerModelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-toner-model-form">
                    <div class="form-group">
                        <label class="form-label" for="edit-toner-model-name">Toner Model Name *</label>
                        <input type="text" id="edit-toner-model-name" class="form-control" required>
                        <div class="validation-message">Please enter a toner model name</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-toner-model-type">Type (Optional)</label>
                        <input type="text" id="edit-toner-model-type" class="form-control">
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ Save Changes</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="tonerApp.closeEditTonerModelModal()">
                            <span>‚úñÔ∏è Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="addSupplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Supplier</h2>
                <span class="modal-close" onclick="tonerApp.closeAddSupplierModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-supplier-form">
                    <div class="form-group">
                        <label class="form-label" for="new-supplier-name">Supplier Name *</label>
                        <input type="text" id="new-supplier-name" class="form-control" placeholder="e.g., Office Depot" required>
                        <div class="validation-message">Please enter a supplier name</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-supplier-contact">Contact Info (Optional)</label>
                        <input type="text" id="new-supplier-contact" class="form-control" placeholder="e.g., John Doe, +1234567890">
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span>‚ûï Add Supplier</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="editSupplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Supplier</h2>
                <span class="modal-close" onclick="tonerApp.closeEditSupplierModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-supplier-form">
                    <div class="form-group">
                        <label class="form-label" for="edit-supplier-name">Supplier Name *</label>
                        <input type="text" id="edit-supplier-name" class="form-control" required>
                        <div class="validation-message">Please enter a supplier name</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-supplier-contact">Contact Info (Optional)</label>
                        <input type="text" id="edit-supplier-contact" class="form-control">
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ Save Changes</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="tonerApp.closeEditSupplierModal()">
                            <span>‚úñÔ∏è Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="confirm-title">Confirm Action</h2>
                <span class="modal-close" onclick="tonerApp.closeConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure you want to proceed?</p>
                <div class="btn-group" style="margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="tonerApp.cancelConfirm()">Cancel</button>
                    <button class="btn btn-danger" onclick="tonerApp.executeConfirm()">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="offline-indicator">
        You are currently offline. Data might not be saved.
    </div>

    <script>
        // Global variable for primary color from CSS for charts - MUST be defined before TonerApp class
        const var_primary_color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();

        // Declare tonerApp globally so it can be accessed by HTML onclick attributes
        let tonerApp; 

        class TonerApp {
            constructor() {
                this.tonerEntries = this.loadEntries();
                this.departments = this.loadDepartments();
                this.tonerModels = this.loadTonerModels(); // New: Load toner models
                this.suppliers = this.loadSuppliers();     // New: Load suppliers
                this.auditLog = this.loadAuditLog();
                this.settings = this.loadSettings();
                this.currentEditEntryId = null; // To store the ID of the entry being edited
                this.currentEditTonerModelId = null; // New: To store the ID of the toner model being edited
                this.currentEditSupplierId = null;   // New: To store the ID of the supplier being edited
                this.confirmCallback = null; // For custom confirm modal
                this.autoBackupInterval = null; // To store the interval ID for auto backup

                this.initializeTheme();
                this.setupEventListeners();
                this.renderAllContent(); // Render everything on load
                this.applyInitialFilters(); // Apply filters if any from settings
                this.setupAutoBackup(); // Setup auto backup on app load
            }

            // Data Management
            loadEntries() {
                return JSON.parse(localStorage.getItem('tonerEntries')) || [];
            }

            saveEntries() {
                localStorage.setItem('tonerEntries', JSON.stringify(this.tonerEntries));
                this.addLog('info', 'Toner entries saved.');
                if (this.settings.autoBackup) {
                    this.performAutoBackup(); // Trigger auto-backup on manual save
                }
            }

            loadDepartments() {
                return JSON.parse(localStorage.getItem('departments')) || [];
            }

            saveDepartments() {
                localStorage.setItem('departments', JSON.stringify(this.departments));
                this.addLog('info', 'Departments saved.');
            }

            // New: Load toner models
            loadTonerModels() {
                return JSON.parse(localStorage.getItem('tonerModels')) || [
                    // Default toner models if none exist
                    { id: 1, name: 'CK-4520', type: 'Black' },
                    { id: 2, name: 'TN-3417', type: 'Black' },
                    { id: 3, name: 'TN 2305', type: 'Black' },
                    { id: 4, name: 'TN 2405', type: 'Black' },
                    { id: 5, name: 'TN 3607', type: 'Black' },
                    { id: 6, name: 'TN-3320', type: 'Black' },
                    { id: 7, name: '147A(W1470A)', type: 'Black' },
                    { id: 8, name: '59A(CF259A)', type: 'Black' },
                    { id: 9, name: 'CK-8520 M', type: 'Magenta' },
                    { id: 10, name: 'CK-8520 Y', type: 'Yellow' },
                    { id: 11, name: 'CK-8520 C', type: 'Cyan' },
                    { id: 12, name: 'CK-8520 K', type: 'Black' }
                ];
            }

            // New: Save toner models
            saveTonerModels() {
                localStorage.setItem('tonerModels', JSON.stringify(this.tonerModels));
                this.addLog('info', 'Toner models saved.');
            }

            // New: Load suppliers
            loadSuppliers() {
                return JSON.parse(localStorage.getItem('suppliers')) || [
                    // Default suppliers if none exist
                    { id: 1, name: 'Ivory Computers', contact: 'sales@ivory.com' },
                    { id: 2, name: 'Starlink', contact: '+971 4 123 4567' },
                    { id: 3, name: 'SSIT', contact: 'info@ssit.ae' }
                ];
            }

            // New: Save suppliers
            saveSuppliers() {
                localStorage.setItem('suppliers', JSON.stringify(this.suppliers));
                this.addLog('info', 'Suppliers saved.');
            }

            loadAuditLog() {
                return JSON.parse(localStorage.getItem('auditLog')) || [];
            }

            saveAuditLog() {
                localStorage.setItem('auditLog', JSON.stringify(this.auditLog));
            }

            addLog(type, message) {
                const timestamp = new Date().toLocaleString();
                this.auditLog.unshift({ timestamp, type, message }); // Add to beginning
                if (this.auditLog.length > 500) { // Keep log size manageable
                    this.auditLog.pop();
                }
                this.saveAuditLog();
                if (document.getElementById('audit-log').classList.contains('active')) {
                    this.renderAuditLog(); // Re-render if log tab is active
                }
            }

            loadSettings() {
                const defaultSettings = {
                    darkMode: false,
                    vatRate: 5, // Default VAT rate
                    autoBackup: false,
                    preferredBackupDirectory: '', // New setting
                    lastAutoBackup: null // New: Timestamp for last auto backup
                };
                return { ...defaultSettings, ...JSON.parse(localStorage.getItem('settings')) };
            }

            saveSettings() {
                localStorage.setItem('settings', JSON.stringify(this.settings));
                this.addLog('info', 'Settings saved.');
            }

            // UI and Navigation
            switchTab(tabId) {
                // Deactivate all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                // Deactivate all nav tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Activate selected tab content
                document.getElementById(tabId).classList.add('active');
                
                // Activate selected nav tab using data-tab-id
                const selectedNavTab = document.querySelector(`.nav-tab[data-tab-id="${tabId}"]`);
                if (selectedNavTab) {
                    selectedNavTab.classList.add('active');
                }
                
                // Update dashboard when switching to it
                if (tabId === 'dashboard') {
                    this.updateDashboard();
                }
                // Re-render all entries when switching to it
                if (tabId === 'all-entries') {
                    this.renderAllEntries();
                }
                // Update analytics when switching to it
                if (tabId === 'analytics') {
                    this.updateAnalytics();
                }
                // New: Re-render master data lists when switching to it
                if (tabId === 'master-data') {
                    this.renderDepartmentsList();
                    this.renderTonerModelsList();
                    this.renderSuppliersList();
                }
                // New: Re-render reports when switching to it
                if (tabId === 'reports') {
                    this.updateReports();
                }
            }

            // Modal functions
            closeModal() {
                document.getElementById('historyModal').style.display = 'none';
            }
            
            closeEditModal() {
                document.getElementById('editModal').style.display = 'none';
            }

            closeAddDepartmentModal() {
                document.getElementById('addDepartmentModal').style.display = 'none';
                document.getElementById('add-department-form').reset();
            }

            // New: Close Add Toner Model Modal
            closeAddTonerModelModal() {
                document.getElementById('addTonerModelModal').style.display = 'none';
                document.getElementById('add-toner-model-form').reset();
            }

            // New: Close Edit Toner Model Modal
            closeEditTonerModelModal() {
                document.getElementById('editTonerModelModal').style.display = 'none';
            }

            // New: Close Add Supplier Modal
            closeAddSupplierModal() {
                document.getElementById('addSupplierModal').style.display = 'none';
                document.getElementById('add-supplier-form').reset();
            }

            // New: Close Edit Supplier Modal
            closeEditSupplierModal() {
                document.getElementById('editSupplierModal').style.display = 'none';
            }

            // Custom Confirm Modal
            showConfirmModal(message, callback) {
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirmModal').style.display = 'block';
                this.confirmCallback = callback;
            }

            closeConfirmModal() {
                document.getElementById('confirmModal').style.display = 'none';
                this.confirmCallback = null;
            }

            executeConfirm() {
                if (this.confirmCallback) {
                    this.confirmCallback(true);
                }
                this.closeConfirmModal();
            }

            cancelConfirm() {
                if (this.confirmCallback) {
                    this.confirmCallback(false);
                }
                this.closeConfirmModal();
            }

            // Alert functions
            showAlert(message, type = 'success', duration = 3000) {
                const alertContainer = document.getElementById('alert-container');
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.innerHTML = `<i>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</i> ${message}`;
                alertContainer.prepend(alertDiv); // Add to the top

                setTimeout(() => {
                    alertDiv.remove();
                }, duration);
            }

            // Form Handling for Add Entry
            setupEventListeners() {
                document.getElementById('toner-form').addEventListener('submit', this.addTonerEntry.bind(this));
                document.getElementById('edit-toner-form').addEventListener('submit', this.saveEdit.bind(this));
                document.getElementById('add-department-form').addEventListener('submit', this.addDepartment.bind(this));
                document.getElementById('add-toner-model-form').addEventListener('submit', this.addTonerModel.bind(this)); // New
                document.getElementById('edit-toner-model-form').addEventListener('submit', this.saveEditedTonerModel.bind(this)); // New
                document.getElementById('add-supplier-form').addEventListener('submit', this.addSupplier.bind(this)); // New
                document.getElementById('edit-supplier-form').addEventListener('submit', this.saveEditedSupplier.bind(this)); // New

                document.getElementById('editModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('editModal')) {
                        this.closeEditModal();
                    }
                });
                document.getElementById('addDepartmentModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('addDepartmentModal')) {
                        this.closeAddDepartmentModal();
                    }
                });
                // New: Event listeners for new modals
                document.getElementById('addTonerModelModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('addTonerModelModal')) {
                        this.closeAddTonerModelModal();
                    }
                });
                document.getElementById('editTonerModelModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('editTonerModelModal')) {
                        this.closeEditTonerModelModal();
                    }
                });
                document.getElementById('addSupplierModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('addSupplierModal')) {
                        this.closeAddSupplierModal();
                    }
                });
                document.getElementById('editSupplierModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('editSupplierModal')) {
                        this.closeEditSupplierModal();
                    }
                });
                document.getElementById('confirmModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('confirmModal')) {
                        this.cancelConfirm(); // If user clicks outside, treat as cancel
                    }
                });
            }

            addTonerEntry(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please fill in all required fields correctly.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const department = document.getElementById('department').value;
                const tonerModel = document.getElementById('toner-model').value;
                const date = document.getElementById('date').value;
                const invoice = document.getElementById('invoice').value;
                const supplier = document.getElementById('supplier').value;
                const price = parseFloat(document.getElementById('price').value);
                const quantity = parseInt(document.getElementById('quantity').value);
                const comments = document.getElementById('comments').value;

                const vatRate = this.settings.vatRate / 100;
                const totalCost = price * quantity;
                const vatAmount = totalCost * vatRate;
                const totalInclVat = totalCost + vatAmount;

                const newEntry = {
                    id: Date.now(), // Unique ID for each entry
                    department,
                    tonerModel,
                    date,
                    invoice,
                    supplier,
                    price,
                    quantity,
                    totalCost: totalCost.toFixed(2),
                    vatAmount: vatAmount.toFixed(2),
                    totalInclVat: totalInclVat.toFixed(2),
                    comments
                };

                this.tonerEntries.unshift(newEntry); // Add to the beginning for recent view
                this.saveEntries();
                this.clearForm();
                this.renderAllContent(); // Re-render all relevant sections
                this.addLog('add', `Added new entry: ${tonerModel} for ${department} (Qty: ${quantity})`);
                this.showAlert('Toner entry added successfully!', 'success');
            }

            clearForm() {
                document.getElementById('toner-form').reset();
                document.getElementById('toner-form').classList.remove('was-validated');
                this.populateDepartmentsDropdown('department');
                this.populateTonerModelsDropdown('toner-model');
                this.populateSuppliersDropdown('supplier');
            }

            // Data Rendering
            renderAllContent() {
                this.populateDepartmentsDropdown('department');
                this.populateDepartmentsDropdown('filter-all-department');
                this.populateDepartmentsDropdown('edit-department');
                this.populateDepartmentsMultiSelect('export-department-select'); // Use new function for multi-select
                this.populateTonerModelsDropdown('toner-model');
                this.populateTonerModelsDropdown('edit-toner-model');
                this.populateSuppliersDropdown('supplier');
                this.populateSuppliersDropdown('edit-supplier');
                this.updateDashboard();
                this.renderAllEntries();
                this.renderDepartmentsList(); // Render master data lists
                this.renderTonerModelsList();
                this.renderSuppliersList();
                this.updateAnalytics(); // Initial render for analytics charts
                this.updateReports(); // Initial render for reports charts
                this.renderAuditLog();
                this.populateFilterYears();
                this.populateFilterMonths();
                this.updateLastAutoBackupTimestamp(); // Update timestamp display
            }

            populateDepartmentsDropdown(selectId) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;

                const selectedValue = selectElement.value; // Preserve selected value

                selectElement.innerHTML = '<option value="">Select Department</option>';
                const departments = this.departments.map(dept => dept.name).sort();
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    selectElement.appendChild(option);
                });

                selectElement.value = selectedValue; // Restore selected value
            }

            populateDepartmentsMultiSelect(selectId) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;

                // Store current selections to restore them
                const selectedValues = Array.from(selectElement.options)
                                            .filter(option => option.selected)
                                            .map(option => option.value);

                selectElement.innerHTML = ''; // Clear all options

                const departments = this.departments.map(dept => dept.name).sort();
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    option.selected = selectedValues.includes(dept); // Restore selection
                    selectElement.appendChild(option);
                });
            }

            // Helper function to validate toner model names
            isValidTonerModelName(name) {
                const trimmedName = name.trim();
                // Exclude very short strings (e.g., single characters), common single-letter color codes,
                // and known unwanted words based on the image provided.
                const unwantedWords = new Set(['C', 'K', 'M', 'Y', 'Pure', 'Unit', 'K)']); 
                return trimmedName.length > 1 && !unwantedWords.has(trimmedName);
            }

            populateTonerModelsDropdown(selectId) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;

                const selectedValue = selectElement.value; // Preserve selected value

                // Clear existing options, but keep "Select Toner Model"
                selectElement.innerHTML = '<option value="">Select Toner Model</option>';

                // Use a Set to store unique and valid toner models
                const allModels = new Set();

                // Add from stored tonerModels (master data)
                this.tonerModels.forEach(model => {
                    if (this.isValidTonerModelName(model.name)) {
                        allModels.add(model.name.trim());
                    }
                });

                // Add from default department models (if they exist and are valid)
                this.departments.forEach(dept => {
                    if (dept.defaultModels) {
                        // Split by comma and process each potential model name
                        dept.defaultModels.split(',').map(m => m.trim()).forEach(m => {
                            if (this.isValidTonerModelName(m)) {
                                allModels.add(m);
                            }
                        });
                    }
                });

                // Also add any models from existing entries that might not be in the master data
                // This ensures historical data models are still selectable
                this.tonerEntries.forEach(entry => {
                    if (this.isValidTonerModelName(entry.tonerModel)) {
                        allModels.add(entry.tonerModel.trim());
                    }
                });

                // Convert Set to Array, sort alphabetically, and add to the dropdown
                const sortedModels = Array.from(allModels).sort();
                sortedModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    selectElement.appendChild(option);
                });

                selectElement.value = selectedValue; // Restore selected value
            }

            populateSuppliersDropdown(selectId) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;

                const selectedValue = selectElement.value; // Preserve selected value

                selectElement.innerHTML = '<option value="">Select Supplier</option>';
                // Get unique suppliers from stored suppliers and existing entries
                const allSuppliers = new Set();
                this.suppliers.forEach(supplier => allSuppliers.add(supplier.name)); // Add from stored suppliers
                this.tonerEntries.forEach(entry => allSuppliers.add(entry.supplier)); // Add from entries

                const sortedSuppliers = Array.from(allSuppliers).sort();
                sortedSuppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier;
                    option.textContent = supplier;
                    selectElement.appendChild(option);
                });

                selectElement.value = selectedValue; // Restore selected value
            }

            updateDashboard() {
                const totalEntries = this.tonerEntries.length;
                const totalDepartments = this.departments.length;
                const totalSpent = this.tonerEntries.reduce((sum, entry) => sum + parseFloat(entry.totalInclVat), 0);
                const totalQuantity = this.tonerEntries.reduce((sum, entry) => sum + entry.quantity, 0);

                document.getElementById('total-entries').textContent = totalEntries;
                document.getElementById('total-departments').textContent = totalDepartments;
                document.getElementById('total-spent').textContent = `AED ${totalSpent.toFixed(2)}`;
                document.getElementById('total-quantity').textContent = totalQuantity;

                this.renderTopDepartmentsBySpending();
                this.renderTopTonerModelsByQuantity();
                this.renderKeyFinancialOverviews();
                this.renderDepartmentConsumptionDetails();
                this.renderRecentPurchases();
            }

            renderTopDepartmentsBySpending() {
                const departmentSpending = {};
                this.tonerEntries.forEach(entry => {
                    departmentSpending[entry.department] = (departmentSpending[entry.department] || 0) + parseFloat(entry.totalInclVat);
                });

                const sortedDepartments = Object.entries(departmentSpending)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                const list = document.getElementById('top-departments-spending').querySelector('ul');
                list.innerHTML = '';
                if (sortedDepartments.length === 0) {
                    list.innerHTML = '<li class="empty-state">No data available</li>';
                    return;
                }
                sortedDepartments.forEach(([dept, spending]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${dept}</span> <strong>AED ${spending.toFixed(2)}</strong>`;
                    list.appendChild(li);
                });
            }

            renderTopTonerModelsByQuantity() {
                const tonerModelQuantity = {};
                this.tonerEntries.forEach(entry => {
                    tonerModelQuantity[entry.tononerModel] = (tonerModelQuantity[entry.tonerModel] || 0) + entry.quantity;
                });

                const sortedModels = Object.entries(tonerModelQuantity)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                const list = document.getElementById('top-toner-models').querySelector('ul');
                list.innerHTML = '';
                if (sortedModels.length === 0) {
                    list.innerHTML = '<li class="empty-state">No data available</li>';
                    return;
                }
                sortedModels.forEach(([model, quantity]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${model}</span> <strong>${quantity} units</strong>`;
                    list.appendChild(li);
                });
            }

            renderKeyFinancialOverviews() {
                const supplierSpending = {};
                let overallTotalPrice = 0;
                let overallTotalQuantity = 0;

                this.tonerEntries.forEach(entry => {
                    supplierSpending[entry.supplier] = (supplierSpending[entry.supplier] || 0) + parseFloat(entry.totalInclVat);
                    overallTotalPrice += parseFloat(entry.price) * entry.quantity;
                    overallTotalQuantity += entry.quantity;
                });

                const highestSpendingSupplier = Object.entries(supplierSpending).sort(([, a], [, b]) => b - a)[0];
                const overallAvgPrice = overallTotalQuantity > 0 ? (overallTotalPrice / overallTotalQuantity) : 0;

                document.getElementById('highest-spending-supplier').textContent = highestSpendingSupplier ? `AED ${highestSpendingSupplier[1].toFixed(2)} (${highestSpendingSupplier[0]})` : 'AED 0';
                document.getElementById('overall-avg-price').textContent = `AED ${overallAvgPrice.toFixed(2)}`;
            }

            renderDepartmentConsumptionDetails() {
                const container = document.getElementById('department-consumption-details');
                container.innerHTML = '';

                const filterYear = document.getElementById('filter-consumption-year').value;
                const filterMonth = document.getElementById('filter-consumption-month').value;

                const filteredEntries = this.tonerEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    const matchesYear = filterYear ? entryDate.getFullYear() === parseInt(filterYear) : true;
                    const matchesMonth = filterMonth ? (entryDate.getMonth() + 1) === parseInt(filterMonth) : true;
                    return matchesYear && matchesMonth;
                });

                const departmentData = {};
                filteredEntries.forEach(entry => {
                    if (!departmentData[entry.department]) {
                        departmentData[entry.department] = { totalQuantity: 0, totalSpending: 0, distinctModels: new Set() };
                    }
                    departmentData[entry.department].totalQuantity += entry.quantity;
                    departmentData[entry.department].totalSpending += parseFloat(entry.totalInclVat);
                    departmentData[entry.department].distinctModels.add(entry.tonerModel);
                });

                const sortedDepartments = Object.entries(departmentData).sort(([, a], [, b]) => b.totalSpending - a.totalSpending);

                if (sortedDepartments.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No Consumption Data</h3><p>Adjust filters or add more entries.</p></div>';
                    return;
                }

                let tableHtml = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Units Used</th>
                                <th>Total Spent (AED)</th>
                                <th>Distinct Models</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedDepartments.forEach(([deptName, data]) => {
                    tableHtml += `
                        <tr>
                            <td>${deptName}</td>
                            <td>${data.totalQuantity}</td>
                            <td>AED ${data.totalSpending.toFixed(2)}</td>
                            <td>${data.distinctModels.size}</td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                    </table>
                `;
                container.innerHTML = tableHtml;
            }

            populateFilterYears() {
                const yearSelect = document.getElementById('filter-consumption-year');
                if (!yearSelect) return;
                const currentSelectedYear = yearSelect.value;
                const years = new Set(this.tonerEntries.map(entry => new Date(entry.date).getFullYear()));
                yearSelect.innerHTML = '<option value="">All Years</option>';
                Array.from(years).sort((a, b) => b - a).forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                yearSelect.value = currentSelectedYear;
            }

            populateFilterMonths() {
                // Month options are static, no dynamic population needed based on data
                // This function mainly serves to be called when rendering to ensure dropdown is present
            }

            applyConsumptionFilters() {
                this.renderDepartmentConsumptionDetails();
            }

            renderRecentPurchases() {
                const tableBody = document.getElementById('recent-purchases');
                tableBody.innerHTML = '';

                const searchInput = document.getElementById('search-recent').value.toLowerCase();

                const recentEntries = this.tonerEntries
                    .slice(0, 10) // Display only recent 10 entries
                    .filter(entry => {
                        const searchMatch = searchInput === '' ||
                            entry.department.toLowerCase().includes(searchInput) ||
                            entry.tonerModel.toLowerCase().includes(searchInput) ||
                            entry.supplier.toLowerCase().includes(searchInput) ||
                            entry.invoice.toLowerCase().includes(searchInput) ||
                            entry.comments.toLowerCase().includes(searchInput);
                        return searchMatch;
                    });

                if (recentEntries.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="10" class="empty-state">No recent entries found.</td></tr>`;
                    return;
                }

                recentEntries.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = entry.department;
                    row.insertCell().textContent = entry.date;
                    row.insertCell().textContent = entry.tonerModel;
                    row.insertCell().textContent = entry.supplier;
                    row.insertCell().textContent = entry.quantity;
                    row.insertCell().textContent = `AED ${entry.totalCost}`;
                    row.insertCell().textContent = `AED ${entry.vatAmount}`;
                    row.insertCell().textContent = `AED ${entry.totalInclVat}`;
                    row.insertCell().textContent = entry.comments;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-cell';
                    const editButton = document.createElement('button');
                    editButton.className = 'btn-icon';
                    editButton.innerHTML = '‚úèÔ∏è';
                    editButton.title = 'Edit Entry';
                    editButton.onclick = () => this.openEditModal(entry.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn-icon';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.title = 'Delete Entry';
                    deleteButton.onclick = () => this.deleteEntry(entry.id);
                    actionsCell.appendChild(deleteButton);
                });
            }

            filterRecentPurchases() {
                this.renderRecentPurchases();
            }

            renderAllEntries() {
                const tableBody = document.getElementById('all-entries-table-body');
                tableBody.innerHTML = '';

                const filterDepartment = document.getElementById('filter-all-department').value;
                const searchInput = document.getElementById('search-all-entries').value.toLowerCase();

                const filteredEntries = this.tonerEntries.filter(entry => {
                    const deptMatch = filterDepartment ? entry.department === filterDepartment : true;
                    const searchMatch = searchInput === '' ||
                        entry.tonerModel.toLowerCase().includes(searchInput) ||
                        entry.invoice.toLowerCase().includes(searchInput) ||
                        entry.supplier.toLowerCase().includes(searchInput) ||
                        entry.comments.toLowerCase().includes(searchInput);
                    return deptMatch && searchMatch;
                });

                if (filteredEntries.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="12" class="empty-state">No entries found for the selected filters.</td></tr>`;
                    return;
                }

                filteredEntries.forEach(entry => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = entry.department;
                    row.insertCell().textContent = entry.date;
                    row.insertCell().textContent = entry.tonerModel;
                    row.insertCell().textContent = entry.invoice;
                    row.insertCell().textContent = entry.supplier;
                    row.insertCell().textContent = `AED ${entry.price.toFixed(2)}`;
                    row.insertCell().textContent = entry.quantity;
                    row.insertCell().textContent = `AED ${(entry.price * entry.quantity).toFixed(2)}`;
                    row.insertCell().textContent = `AED ${entry.vatAmount}`;
                    row.insertCell().textContent = `AED ${entry.totalInclVat}`;
                    row.insertCell().textContent = entry.comments;

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-cell';
                    const editButton = document.createElement('button');
                    editButton.className = 'btn-icon';
                    editButton.innerHTML = '‚úèÔ∏è';
                    editButton.title = 'Edit Entry';
                    editButton.onclick = () => this.openEditModal(entry.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn-icon';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.title = 'Delete Entry';
                    deleteButton.onclick = () => this.deleteEntry(entry.id);
                    actionsCell.appendChild(deleteButton);
                });
            }

            filterAllEntries() {
                this.renderAllEntries();
            }

            openEditModal(id) {
                const entryToEdit = this.tonerEntries.find(entry => entry.id === id);
                if (!entryToEdit) {
                    this.showAlert('Entry not found for editing.', 'error');
                    return;
                }

                this.currentEditEntryId = id; // Store the ID

                // Populate departments and toner models in edit modal
                this.populateDepartmentsDropdown('edit-department');
                this.populateTonerModelsDropdown('edit-toner-model');
                this.populateSuppliersDropdown('edit-supplier');

                document.getElementById('edit-department').value = entryToEdit.department;
                document.getElementById('edit-toner-model').value = entryToEdit.tonerModel;
                document.getElementById('edit-date').value = entryToEdit.date;
                document.getElementById('edit-invoice').value = entryToEdit.invoice;
                document.getElementById('edit-supplier').value = entryToEdit.supplier;
                document.getElementById('edit-price').value = entryToEdit.price;
                document.getElementById('edit-quantity').value = entryToEdit.quantity;
                document.getElementById('edit-comments').value = entryToEdit.comments;

                document.getElementById('editModal').style.display = 'block';
            }

            saveEdit(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please fill in all required fields correctly.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const updatedDepartment = document.getElementById('edit-department').value;
                const updatedTonerModel = document.getElementById('edit-toner-model').value;
                const updatedDate = document.getElementById('edit-date').value;
                const updatedInvoice = document.getElementById('edit-invoice').value;
                const updatedSupplier = document.getElementById('edit-supplier').value;
                const updatedPrice = parseFloat(document.getElementById('edit-price').value);
                const updatedQuantity = parseInt(document.getElementById('edit-quantity').value);
                const updatedComments = document.getElementById('edit-comments').value;

                const vatRate = this.settings.vatRate / 100;
                const updatedTotalCost = updatedPrice * updatedQuantity;
                const updatedVatAmount = updatedTotalCost * vatRate;
                const updatedTotalInclVat = updatedTotalCost + updatedVatAmount;

                const entryIndex = this.tonerEntries.findIndex(entry => entry.id === this.currentEditEntryId);

                if (entryIndex !== -1) {
                    this.tonerEntries[entryIndex] = {
                        id: this.currentEditEntryId,
                        department: updatedDepartment,
                        tonerModel: updatedTonerModel,
                        date: updatedDate,
                        invoice: updatedInvoice,
                        supplier: updatedSupplier,
                        price: updatedPrice,
                        quantity: updatedQuantity,
                        totalCost: updatedTotalCost.toFixed(2),
                        vatAmount: updatedVatAmount.toFixed(2),
                        totalInclVat: updatedTotalInclVat.toFixed(2),
                        comments: updatedComments
                    };
                    this.saveEntries();
                    this.renderAllContent(); // Re-render all tables
                    this.closeEditModal();
                    this.addLog('edit', `Edited entry ID: ${this.currentEditEntryId} (Model: ${updatedTonerModel})`);
                    this.showAlert('Toner entry updated successfully!', 'success');
                } else {
                    this.showAlert('Error: Entry not found for update.', 'error');
                }
            }

            deleteEntry(id) {
                this.showConfirmModal('Are you sure you want to delete this entry?', (confirmed) => {
                    if (confirmed) {
                        const initialLength = this.tonerEntries.length;
                        this.tonerEntries = this.tonerEntries.filter(entry => entry.id !== id);
                        if (this.tonerEntries.length < initialLength) {
                            this.saveEntries();
                            this.renderAllContent(); // Re-render all tables
                            this.addLog('delete', `Deleted entry ID: ${id}`);
                            this.showAlert('Entry deleted successfully!', 'success');
                        } else {
                            this.showAlert('Error: Entry not found for deletion.', 'error');
                        }
                    }
                });
            }

            // Department Management
            renderDepartmentsList() {
                const tableBody = document.getElementById('departments-list-body');
                tableBody.innerHTML = '';

                const searchInput = document.getElementById('search-departments').value.toLowerCase();

                const filteredDepartments = this.departments.filter(dept => 
                    dept.name.toLowerCase().includes(searchInput) ||
                    (dept.defaultModels && dept.defaultModels.toLowerCase().includes(searchInput))
                );

                if (filteredDepartments.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="empty-state">No departments found.</td></tr>`;
                    return;
                }

                filteredDepartments.sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = dept.name;
                    row.insertCell().textContent = dept.defaultModels || 'N/A';

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-cell';
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn-icon btn-danger';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.title = 'Delete Department';
                    deleteButton.onclick = () => this.deleteDepartment(dept.id);
                    actionsCell.appendChild(deleteButton);
                });
            }

            openAddDepartmentModal() {
                document.getElementById('addDepartmentModal').style.display = 'block';
            }

            addDepartment(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please enter a department name.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const newDepartmentName = document.getElementById('new-department-name').value.trim();
                const defaultTonerModel = document.getElementById('default-toner-model').value.trim();

                if (this.departments.some(dept => dept.name.toLowerCase() === newDepartmentName.toLowerCase())) {
                    this.showAlert('Department with this name already exists.', 'error');
                    return;
                }

                this.departments.push({
                    id: Date.now(),
                    name: newDepartmentName,
                    defaultModels: defaultTonerModel
                });
                this.saveDepartments();
                this.closeAddDepartmentModal();
                this.renderDepartmentsList();
                this.populateDepartmentsDropdown('department'); // Update other department dropdowns
                this.addLog('add', `Added new department: ${newDepartmentName}`);
                this.showAlert('Department added successfully!', 'success');
            }

            deleteDepartment(id) {
                this.showConfirmModal('Are you sure you want to delete this department? This will NOT delete entries associated with this department.', (confirmed) => {
                    if (confirmed) {
                        const initialLength = this.departments.length;
                        this.departments = this.departments.filter(dept => dept.id !== id);
                        if (this.departments.length < initialLength) {
                            this.saveDepartments();
                            this.renderDepartmentsList();
                            this.populateDepartmentsDropdown('department'); // Update other department dropdowns
                            this.addLog('delete', `Deleted department ID: ${id}`);
                            this.showAlert('Department deleted successfully!', 'success');
                        } else {
                            this.showAlert('Error: Department not found for deletion.', 'error');
                        }
                    }
                });
            }

            // New: Toner Model Management
            renderTonerModelsList() {
                const tableBody = document.getElementById('toner-models-list-body');
                tableBody.innerHTML = '';

                const searchInput = document.getElementById('search-toner-models').value.toLowerCase();

                const filteredTonerModels = this.tonerModels.filter(model => 
                    model.name.toLowerCase().includes(searchInput) ||
                    (model.type && model.type.toLowerCase().includes(searchInput))
                );

                if (filteredTonerModels.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="empty-state">No toner models found.</td></tr>`;
                    return;
                }

                filteredTonerModels.sort((a, b) => a.name.localeCompare(b.name)).forEach(model => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = model.name;
                    row.insertCell().textContent = model.type || 'N/A';

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-cell';
                    const editButton = document.createElement('button');
                    editButton.className = 'btn-icon';
                    editButton.innerHTML = '‚úèÔ∏è';
                    editButton.title = 'Edit Toner Model';
                    editButton.onclick = () => this.openEditTonerModelModal(model.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn-icon btn-danger';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.title = 'Delete Toner Model';
                    deleteButton.onclick = () => this.deleteTonerModel(model.id);
                    actionsCell.appendChild(deleteButton);
                });
            }

            openAddTonerModelModal() {
                document.getElementById('addTonerModelModal').style.display = 'block';
            }

            addTonerModel(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please enter a toner model name.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const newTonerModelName = document.getElementById('new-toner-model-name').value.trim();
                const newTonerModelType = document.getElementById('new-toner-model-type').value.trim();

                if (this.tonerModels.some(model => model.name.toLowerCase() === newTonerModelName.toLowerCase())) {
                    this.showAlert('Toner model with this name already exists.', 'error');
                    return;
                }

                this.tonerModels.push({
                    id: Date.now(),
                    name: newTonerModelName,
                    type: newTonerModelType
                });
                this.saveTonerModels();
                this.closeAddTonerModelModal();
                this.renderTonerModelsList();
                this.populateTonerModelsDropdown('toner-model'); // Update dropdowns
                this.populateTonerModelsDropdown('edit-toner-model');
                this.addLog('add', `Added new toner model: ${newTonerModelName}`);
                this.showAlert('Toner model added successfully!', 'success');
            }

            openEditTonerModelModal(id) {
                const modelToEdit = this.tonerModels.find(model => model.id === id);
                if (!modelToEdit) {
                    this.showAlert('Toner model not found for editing.', 'error');
                    return;
                }
                this.currentEditTonerModelId = id;
                document.getElementById('edit-toner-model-name').value = modelToEdit.name;
                document.getElementById('edit-toner-model-type').value = modelToEdit.type || '';
                document.getElementById('editTonerModelModal').style.display = 'block';
            }

            saveEditedTonerModel(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please enter a toner model name.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const updatedName = document.getElementById('edit-toner-model-name').value.trim();
                const updatedType = document.getElementById('edit-toner-model-type').value.trim();

                const modelIndex = this.tonerModels.findIndex(model => model.id === this.currentEditTonerModelId);

                if (modelIndex !== -1) {
                    // Check for duplicate name, excluding the current model being edited
                    if (this.tonerModels.some(model => model.name.toLowerCase() === updatedName.toLowerCase() && model.id !== this.currentEditTonerModelId)) {
                        this.showAlert('Toner model with this name already exists.', 'error');
                        return;
                    }

                    this.tonerModels[modelIndex] = {
                        id: this.currentEditTonerModelId,
                        name: updatedName,
                        type: updatedType
                    };
                    this.saveTonerModels();
                    this.renderTonerModelsList();
                    this.populateTonerModelsDropdown('toner-model');
                    this.populateTonerModelsDropdown('edit-toner-model');
                    this.closeEditTonerModelModal();
                    this.addLog('edit', `Edited toner model ID: ${this.currentEditTonerModelId} (Name: ${updatedName})`);
                    this.showAlert('Toner model updated successfully!', 'success');
                } else {
                    this.showAlert('Error: Toner model not found for update.', 'error');
                }
            }

            deleteTonerModel(id) {
                this.showConfirmModal('Are you sure you want to delete this toner model? This will NOT affect existing entries.', (confirmed) => {
                    if (confirmed) {
                        const initialLength = this.tonerModels.length;
                        this.tonerModels = this.tonerModels.filter(model => model.id !== id);
                        if (this.tonerModels.length < initialLength) {
                            this.saveTonerModels();
                            this.renderTonerModelsList();
                            this.populateTonerModelsDropdown('toner-model');
                            this.populateTonerModelsDropdown('edit-toner-model');
                            this.addLog('delete', `Deleted toner model ID: ${id}`);
                            this.showAlert('Toner model deleted successfully!', 'success');
                        } else {
                            this.showAlert('Error: Toner model not found for deletion.', 'error');
                        }
                    }
                });
            }

            // New: Supplier Management
            renderSuppliersList() {
                const tableBody = document.getElementById('suppliers-list-body');
                tableBody.innerHTML = '';

                const searchInput = document.getElementById('search-suppliers').value.toLowerCase();

                const filteredSuppliers = this.suppliers.filter(supplier =>
                    supplier.name.toLowerCase().includes(searchInput) ||
                    (supplier.contact && supplier.contact.toLowerCase().includes(searchInput))
                );

                if (filteredSuppliers.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="empty-state">No suppliers found.</td></tr>`;
                    return;
                }

                filteredSuppliers.sort((a, b) => a.name.localeCompare(b.name)).forEach(supplier => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = supplier.name;
                    row.insertCell().textContent = supplier.contact || 'N/A';

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-cell';
                    const editButton = document.createElement('button');
                    editButton.className = 'btn-icon';
                    editButton.innerHTML = '‚úèÔ∏è';
                    editButton.title = 'Edit Supplier';
                    editButton.onclick = () => this.openEditSupplierModal(supplier.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn-icon btn-danger';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.title = 'Delete Supplier';
                    deleteButton.onclick = () => this.deleteSupplier(supplier.id);
                    actionsCell.appendChild(deleteButton);
                });
            }

            openAddSupplierModal() {
                document.getElementById('addSupplierModal').style.display = 'block';
            }

            addSupplier(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please enter a supplier name.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const newSupplierName = document.getElementById('new-supplier-name').value.trim();
                const newSupplierContact = document.getElementById('new-supplier-contact').value.trim();

                if (this.suppliers.some(supplier => supplier.name.toLowerCase() === newSupplierName.toLowerCase())) {
                    this.showAlert('Supplier with this name already exists.', 'error');
                    return;
                }

                this.suppliers.push({
                    id: Date.now(),
                    name: newSupplierName,
                    contact: newSupplierContact
                });
                this.saveSuppliers();
                this.closeAddSupplierModal();
                this.renderSuppliersList();
                this.populateSuppliersDropdown('supplier'); // Update dropdowns
                this.populateSuppliersDropdown('edit-supplier');
                this.addLog('add', `Added new supplier: ${newSupplierName}`);
                this.showAlert('Supplier added successfully!', 'success');
            }

            openEditSupplierModal(id) {
                const supplierToEdit = this.suppliers.find(supplier => supplier.id === id);
                if (!supplierToEdit) {
                    this.showAlert('Supplier not found for editing.', 'error');
                    return;
                }
                this.currentEditSupplierId = id;
                document.getElementById('edit-supplier-name').value = supplierToEdit.name;
                document.getElementById('edit-supplier-contact').value = supplierToEdit.contact || '';
                document.getElementById('editSupplierModal').style.display = 'block';
            }

            saveEditedSupplier(event) {
                event.preventDefault();
                const form = event.target;
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    this.showAlert('Please enter a supplier name.', 'error');
                    return;
                }
                form.classList.remove('was-validated');

                const updatedName = document.getElementById('edit-supplier-name').value.trim();
                const updatedContact = document.getElementById('edit-supplier-contact').value.trim();

                const supplierIndex = this.suppliers.findIndex(supplier => supplier.id === this.currentEditSupplierId);

                if (supplierIndex !== -1) {
                    // Check for duplicate name, excluding the current supplier being edited
                    if (this.suppliers.some(supplier => supplier.name.toLowerCase() === updatedName.toLowerCase() && supplier.id !== this.currentEditSupplierId)) {
                        this.showAlert('Supplier with this name already exists.', 'error');
                        return;
                    }

                    this.suppliers[supplierIndex] = {
                        id: this.currentEditSupplierId,
                        name: updatedName,
                        contact: updatedContact
                    };
                    this.saveSuppliers();
                    this.renderSuppliersList();
                    this.populateSuppliersDropdown('supplier');
                    this.populateSuppliersDropdown('edit-supplier');
                    this.closeEditSupplierModal();
                    this.addLog('edit', `Edited supplier ID: ${this.currentEditSupplierId} (Name: ${updatedName})`);
                    this.showAlert('Supplier updated successfully!', 'success');
                } else {
                    this.showAlert('Error: Supplier not found for update.', 'error');
                }
            }

            deleteSupplier(id) {
                this.showConfirmModal('Are you sure you want to delete this supplier? This will NOT affect existing entries.', (confirmed) => {
                    if (confirmed) {
                        const initialLength = this.suppliers.length;
                        this.suppliers = this.suppliers.filter(supplier => supplier.id !== id);
                        if (this.suppliers.length < initialLength) {
                            this.saveSuppliers();
                            this.renderSuppliersList();
                            this.populateSuppliersDropdown('supplier');
                            this.populateSuppliersDropdown('edit-supplier');
                            this.addLog('delete', `Deleted supplier ID: ${id}`);
                            this.showAlert('Supplier deleted successfully!', 'success');
                        } else {
                            this.showAlert('Error: Supplier not found for deletion.', 'error');
                        }
                    }
                });
            }

            // Reporting and Export
            exportAllData() {
                const dataStr = JSON.stringify({
                    tonerEntries: this.tonerEntries,
                    departments: this.departments,
                    tonerModels: this.tonerModels, // New
                    suppliers: this.suppliers,     // New
                    auditLog: this.auditLog,
                    settings: this.settings
                }, null, 2);
                this.downloadFile(dataStr, 'toner_management_full_data.json', 'application/json');
                const backupPath = this.settings.preferredBackupDirectory || 'browser default download location';
                this.addLog('backup', `Exported all system data. Downloaded to: ${backupPath}`);
                this.showAlert('All data exported successfully!', 'success');
            }

            exportAllDataXLSX() {
                try {
                    const wb = XLSX.utils.book_new();

                    // Toner Entries Sheet
                    const tonerEntriesData = this.tonerEntries.map(entry => ({
                        'Department': entry.department,
                        'Date': entry.date,
                        'Toner Model': entry.tonerModel,
                        'Invoice #': entry.invoice,
                        'Supplier': entry.supplier,
                        'Unit Price (AED)': parseFloat(entry.price),
                        'Quantity': entry.quantity,
                        'Total Cost (AED)': parseFloat(entry.totalCost),
                        'VAT (AED)': parseFloat(entry.vatAmount),
                        'Total Incl. VAT (AED)': parseFloat(entry.totalInclVat),
                        'Comments': entry.comments
                    }));
                    const wsEntries = XLSX.utils.json_to_sheet(tonerEntriesData);
                    XLSX.utils.book_append_sheet(wb, wsEntries, 'Toner Entries');

                    // Departments Sheet
                    const departmentsData = this.departments.map(dept => ({
                        'Department Name': dept.name,
                        'Default Toner Models': dept.defaultModels || 'N/A'
                    }));
                    const wsDepartments = XLSX.utils.json_to_sheet(departmentsData);
                    XLSX.utils.book_append_sheet(wb, wsDepartments, 'Departments');

                    // Toner Models Sheet
                    const tonerModelsData = this.tonerModels.map(model => ({
                        'Model Name': model.name,
                        'Type': model.type || 'N/A'
                    }));
                    const wsTonerModels = XLSX.utils.json_to_sheet(tonerModelsData);
                    XLSX.utils.book_append_sheet(wb, wsTonerModels, 'Toner Models');

                    // Suppliers Sheet
                    const suppliersData = this.suppliers.map(supplier => ({
                        'Supplier Name': supplier.name,
                        'Contact Info': supplier.contact || 'N/A'
                    }));
                    const wsSuppliers = XLSX.utils.json_to_sheet(suppliersData);
                    XLSX.utils.book_append_sheet(wb, wsSuppliers, 'Suppliers');

                    // Audit Log Sheet
                    const auditLogData = this.auditLog.map(log => ({
                        'Timestamp': log.timestamp,
                        'Type': log.type,
                        'Message': log.message
                    }));
                    const wsAuditLog = XLSX.utils.json_to_sheet(auditLogData);
                    XLSX.utils.book_append_sheet(wb, wsAuditLog, 'Audit Log');

                    // Settings Sheet (optional, simple key-value)
                    const settingsData = Object.entries(this.settings).map(([key, value]) => ({
                        'Setting': key,
                        'Value': typeof value === 'object' ? JSON.stringify(value) : value
                    }));
                    const wsSettings = XLSX.utils.json_to_sheet(settingsData);
                    XLSX.utils.book_append_sheet(wb, wsSettings, 'Settings');

                    XLSX.writeFile(wb, 'toner_management_full_data.xlsx');
                    const backupPath = this.settings.preferredBackupDirectory || 'browser default download location';
                    this.addLog('backup', `Exported all system data to XLSX. Downloaded to: ${backupPath}`);
                    this.showAlert('All data exported to XLSX successfully!', 'success');
                } catch (error) {
                    this.showAlert('Error exporting data to XLSX: ' + error.message, 'error');
                    console.error('XLSX export error:', error);
                }
            }

            exportDepartmentSummary() {
                const departmentSummary = {};
                this.tonerEntries.forEach(entry => {
                    if (!departmentSummary[entry.department]) {
                        departmentSummary[entry.department] = {
                            totalQuantity: 0,
                            totalSpending: 0,
                            tonerModels: {}
                        };
                    }
                    departmentSummary[entry.department].totalQuantity += entry.quantity;
                    departmentSummary[entry.department].totalSpending += parseFloat(entry.totalInclVat);
                    departmentSummary[entry.department].tonerModels[entry.tonerModel] = (departmentSummary[entry.department].tonerModels[entry.tonerModel] || 0) + entry.quantity;
                });

                let csvContent = "Department,Total Quantity,Total Spending (AED),Toner Models (Quantity)\n";
                for (const dept in departmentSummary) {
                    const models = Object.entries(departmentSummary[dept].tonerModels)
                        .map(([model, qty]) => `${model} (${qty})`)
                        .join('; ');
                    csvContent += `${dept},${departmentSummary[dept].totalQuantity},${departmentSummary[dept].totalSpending.toFixed(2)},"${models}"\n`;
                }
                this.downloadFile(csvContent, 'toner_department_summary.csv', 'text/csv');
                this.addLog('report', 'Exported department summary.');
                this.showAlert('Department summary exported successfully!', 'success');
            }

            // New: Export Toner Model Usage Report
            exportTonerModelUsageReport() {
                const tonerModelUsage = {};
                this.tonerEntries.forEach(entry => {
                    if (!tonerModelUsage[entry.tonerModel]) {
                        tonerModelUsage[entry.tonerModel] = { totalQuantity: 0, totalSpending: 0 };
                    }
                    tonerModelUsage[entry.tonerModel].totalQuantity += entry.quantity;
                    tonerModelUsage[entry.tonerModel].totalSpending += parseFloat(entry.totalInclVat);
                });

                let csvContent = "Toner Model,Total Quantity,Total Spending (AED)\n";
                Object.entries(tonerModelUsage).sort(([, a], [, b]) => b.totalQuantity - a.totalQuantity).forEach(([model, data]) => {
                    csvContent += `${model},${data.totalQuantity},${data.totalSpending.toFixed(2)}\n`;
                });
                this.downloadFile(csvContent, 'toner_model_usage_report.csv', 'text/csv');
                this.addLog('report', 'Exported toner model usage report.');
                this.showAlert('Toner model usage report exported successfully!', 'success');
            }

            // New: Export Supplier Purchase History
            exportSupplierPurchaseHistory() {
                const supplierHistory = {};
                this.tonerEntries.forEach(entry => {
                    if (!supplierHistory[entry.supplier]) {
                        supplierHistory[entry.supplier] = [];
                    }
                    supplierHistory[entry.supplier].push(entry);
                });

                let csvContent = "Supplier,Date,Toner Model,Invoice #,Quantity,Unit Price (AED),Total Cost (AED),VAT (AED),Total Incl. VAT (AED),Comments\n";
                Object.entries(supplierHistory).sort(([s1], [s2]) => s1.localeCompare(s2)).forEach(([supplierName, entries]) => {
                    entries.forEach(entry => {
                        csvContent += `"${supplierName}",${entry.date},"${entry.tonerModel}","${entry.invoice}",${entry.quantity},${entry.price.toFixed(2)},${entry.totalCost},${entry.vatAmount},${entry.totalInclVat},"${entry.comments.replace(/"/g, '""')}"\n`;
                    });
                });
                this.downloadFile(csvContent, 'supplier_purchase_history.csv', 'text/csv');
                this.addLog('report', 'Exported supplier purchase history report.');
                this.showAlert('Supplier purchase history report exported successfully!', 'success');
            }

            // New: Export Monthly Spending Report
            exportMonthlySpendingReport() {
                const monthlySpending = {}; // {YYYY-MM: totalSpending }
                this.tonerEntries.forEach(entry => {
                    const monthYear = new Date(entry.date).toISOString().substring(0, 7); //YYYY-MM
                    monthlySpending[monthYear] = (monthlySpending[monthYear] || 0) + parseFloat(entry.totalInclVat);
                });

                let csvContent = "Month,Total Spending (AED)\n";
                Object.keys(monthlySpending).sort().forEach(month => { // Sort by month chronologically
                    csvContent += `${month},${monthlySpending[month].toFixed(2)}\n`;
                });
                this.downloadFile(csvContent, 'monthly_spending_report.csv', 'text/csv');
                this.addLog('report', 'Exported monthly spending report.');
                this.showAlert('Monthly spending report exported successfully!', 'success');
            }

            exportJsonData(withPrompt = true) {
                const dataStr = JSON.stringify({
                    tonerEntries: this.tonerEntries,
                    departments: this.departments,
                    tonerModels: this.tonerModels,
                    suppliers: this.suppliers,
                    auditLog: this.auditLog,
                    settings: this.settings
                }, null, 2);
                const backupPath = this.settings.preferredBackupDirectory || 'browser default download location';
                if (withPrompt) {
                    this.downloadFile(dataStr, 'toner_management_full_data.json', 'application/json');
                    this.addLog('backup', `Manually exported toner entries backup. Downloaded to: ${backupPath}`);
                    this.showAlert('Toner entries backed up successfully!', 'success');
                } else {
                    // For silent auto-backup, overwrite the 'tonerEntriesBackup' in local storage
                    localStorage.setItem('tonerEntriesBackup', dataStr);
                    this.settings.lastAutoBackup = new Date().toLocaleString();
                    this.saveSettings();
                    this.updateLastAutoBackupTimestamp(); // Update display
                    this.addLog('backup', `Auto-backup performed. Saved to: ${backupPath}`);
                }
            }

            importJsonData(event) {
                const file = event.target.files[0];
                if (!file) {
                    this.showAlert('No file selected.', 'info');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.tonerEntries && Array.isArray(importedData.tonerEntries)) {
                            this.tonerEntries = importedData.tonerEntries;
                            this.departments = importedData.departments || [];
                            this.tonerModels = importedData.tonerModels || this.loadTonerModels(); // Fallback to default if not present
                            this.suppliers = importedData.suppliers || this.loadSuppliers();     // Fallback to default if not present
                            this.auditLog = importedData.auditLog || [];
                            this.settings = { ...this.settings, ...importedData.settings }; // Merge settings
                            
                            this.saveEntries();
                            this.saveDepartments();
                            this.saveTonerModels();
                            this.saveSuppliers();
                            this.saveAuditLog();
                            this.saveSettings();

                            this.renderAllContent(); // Re-render all relevant sections
                            this.addLog('restore', 'Imported all system data from JSON file.');
                            this.showAlert('Data imported successfully!', 'success');
                        } else if (Array.isArray(importedData)) { // Handle old format where only tonerEntries were saved
                            this.tonerEntries = importedData;
                            this.saveEntries();
                            this.renderAllContent();
                            this.addLog('restore', 'Imported toner entries from old JSON file format.');
                            this.showAlert('Toner entries imported successfully (old format)!', 'success');
                        }
                        else {
                            this.showAlert('Invalid JSON format. Expected an object with data arrays or an array of entries.', 'error');
                        }
                    } catch (error) {
                        this.showAlert('Error parsing JSON file: ' + error.message, 'error');
                        console.error('JSON import error:', error);
                    }
                };
                reader.onerror = () => {
                    this.showAlert('Error reading file.', 'error');
                };
                reader.readAsText(file);
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            printReport() {
                window.print();
                this.addLog('report', 'Printed report.');
            }

            exportPDF() {
                this.showAlert('PDF export feature is under development.', 'info');
                this.addLog('report', 'Attempted PDF export.');
            }

            exportDepartmentData() {
                const selectElement = document.getElementById('export-department-select');
                const selectedDepartments = Array.from(selectElement.options)
                                                .filter(option => option.selected)
                                                .map(option => option.value);
                const exportType = document.getElementById('export-type-select').value;

                if (selectedDepartments.length === 0) {
                    this.showAlert('Please select at least one department to export.', 'error');
                    return;
                }

                let filteredEntries = [];
                if (selectedDepartments.length > 0) {
                    filteredEntries = this.tonerEntries.filter(entry => selectedDepartments.includes(entry.department));
                }

                if (filteredEntries.length === 0) {
                    this.showAlert(`No entries found for the selected department(s).`, 'info');
                    return;
                }

                let dataContent;
                let filename;
                let contentType;

                const headers = ["Department", "Date", "Toner Model", "Invoice #", "Supplier", "Unit Price", "Quantity", "Total", "VAT (5%)", "Total (incl. VAT)", "Comments"];

                if (exportType === 'csv') {
                    dataContent = headers.join(',') + '\n' +
                        filteredEntries.map(entry =>
                            `${entry.department},${entry.date},${entry.tonerModel},${entry.invoice},${entry.supplier},${entry.price},${entry.quantity},${entry.totalCost},${entry.vatAmount},${entry.totalInclVat},"${entry.comments.replace(/"/g, '""')}"`
                        ).join('\n');
                    filename = `toner_entries_${selectedDepartments.join('_')}.csv`;
                    contentType = 'text/csv';
                    this.downloadFile(dataContent, filename, contentType);
                    this.addLog('report', `Exported CSV data for department(s): ${selectedDepartments.join(', ')}`);
                    this.showAlert(`Department data exported as CSV successfully!`, 'success');
                } else if (exportType === 'json') {
                    dataContent = JSON.stringify(filteredEntries, null, 2);
                    filename = `toner_entries_${selectedDepartments.join('_')}.json`;
                    contentType = 'application/json';
                    this.downloadFile(dataContent, filename, contentType);
                    this.addLog('report', `Exported JSON data for department(s): ${selectedDepartments.join(', ')}`);
                    this.showAlert(`Department data exported as JSON successfully!`, 'success');
                } else if (exportType === 'xlsx') {
                    try {
                        const wb = XLSX.utils.book_new();
                        selectedDepartments.forEach(deptName => {
                            const deptEntries = filteredEntries.filter(entry => entry.department === deptName);
                            if (deptEntries.length > 0) {
                                const dataForSheet = deptEntries.map(entry => ({
                                    'Department': entry.department,
                                    'Date': entry.date,
                                    'Toner Model': entry.tonerModel,
                                    'Invoice #': entry.invoice,
                                    'Supplier': entry.supplier,
                                    'Unit Price (AED)': parseFloat(entry.price),
                                    'Quantity': entry.quantity,
                                    'Total Cost (AED)': parseFloat(entry.totalCost),
                                    'VAT (AED)': parseFloat(entry.vatAmount),
                                    'Total Incl. VAT (AED)': parseFloat(entry.totalInclVat),
                                    'Comments': entry.comments
                                }));
                                const ws = XLSX.utils.json_to_sheet(dataForSheet);
                                // Sanitize sheet name to max 31 chars and avoid invalid characters
                                const safeSheetName = deptName.replace(/[/\?*\[\]:]/g, '').substring(0, 31);
                                XLSX.utils.book_append_sheet(wb, ws, safeSheetName);
                            }
                        });
                        filename = `toner_entries_${selectedDepartments.join('_')}.xlsx`;
                        XLSX.writeFile(wb, filename);
                        this.addLog('report', `Exported XLSX data for department(s): ${selectedDepartments.join(', ')}`);
                        this.showAlert(`Department data exported as XLSX successfully!`, 'success');
                    } catch (error) {
                        this.showAlert('Error exporting data to XLSX: ' + error.message, 'error');
                        console.error('XLSX export error:', error);
                    }
                } else if (exportType === 'pdf') {
                    this.showAlert('PDF export for specific departments is under development.', 'info');
                    this.addLog('report', `Attempted PDF export for department(s): ${selectedDepartments.join(', ')}`);
                }
            }

            // Audit Log
            renderAuditLog() {
                const tableBody = document.getElementById('audit-log-body');
                tableBody.innerHTML = '';

                const filterType = document.getElementById('filter-log-type').value;
                const searchInput = document.getElementById('search-audit-log').value.toLowerCase();

                const filteredLog = this.auditLog.filter(log => {
                    const typeMatch = filterType ? log.type === filterType : true;
                    const searchMatch = searchInput === '' || log.message.toLowerCase().includes(searchInput);
                    return typeMatch && searchMatch;
                });

                if (filteredLog.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3" class="empty-state">No audit log entries found for the selected filters.</td></tr>`;
                    return;
                }

                filteredLog.forEach(log => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = log.timestamp;
                    row.insertCell().textContent = log.type;
                    row.insertCell().textContent = log.message;
                });
            }

            // Settings
            initializeTheme() {
                if (this.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-toggle').checked = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('dark-mode-toggle').checked = false;
                }
                document.getElementById('vat-rate-input').value = this.settings.vatRate;
                document.getElementById('auto-backup-toggle').checked = this.settings.autoBackup;
                // New: Initialize backup location path
                const backupPathInput = document.getElementById('backup-location-path');
                if (backupPathInput) {
                    backupPathInput.value = this.settings.preferredBackupDirectory;
                }
            }

            toggleDarkMode() {
                this.settings.darkMode = !this.settings.darkMode;
                document.body.classList.toggle('dark-mode', this.settings.darkMode);
                this.saveSettings();
            }

            updateVatRate() {
                const newRate = parseFloat(document.getElementById('vat-rate-input').value);
                if (isNaN(newRate) || newRate < 0 || newRate > 100) {
                    this.showAlert('Please enter a valid VAT rate between 0 and 100.', 'error');
                    document.getElementById('vat-rate-input').value = this.settings.vatRate; // Revert to old value
                    return;
                }
                this.settings.vatRate = newRate;
                this.saveSettings();
                this.showAlert('VAT rate updated successfully!', 'success');
                // Re-calculate totals for existing entries and re-render
                this.tonerEntries.forEach(entry => {
                    const totalCost = entry.price * entry.quantity;
                    const vatAmount = totalCost * (newRate / 100);
                    entry.vatAmount = vatAmount.toFixed(2);
                    entry.totalInclVat = (totalCost + vatAmount).toFixed(2);
                });
                this.saveEntries();
                this.renderAllContent(); // Re-render tables with new VAT
            }

            toggleAutoBackup() {
                this.settings.autoBackup = document.getElementById('auto-backup-toggle').checked;
                this.saveSettings();
                this.setupAutoBackup(); // Re-setup interval based on new setting
                this.showAlert(`Auto backup ${this.settings.autoBackup ? 'enabled' : 'disabled'}.`, 'info');
            }

            // New: Update backup location path
            updateBackupLocation() {
                const newPath = document.getElementById('backup-location-path').value.trim();
                this.settings.preferredBackupDirectory = newPath;
                this.saveSettings();
            }

            clearAllData() {
                this.showConfirmModal('DANGER: Are you sure you want to clear ALL application data? This action cannot be undone.', (confirmed) => {
                    if (confirmed) {
                        localStorage.clear();
                        this.tonerEntries = [];
                        this.departments = [];
                        this.tonerModels = this.loadTonerModels(); // Reset to default models
                        this.suppliers = this.loadSuppliers();     // Reset to default suppliers
                        this.auditLog = [];
                        this.settings = this.loadSettings(); // Reset to default settings
                        this.initializeTheme(); // Re-apply default theme
                        this.renderAllContent();
                        this.setupAutoBackup(); // Re-setup auto backup (will disable if setting is false)
                        this.showAlert('All application data has been cleared.', 'success');
                    }
                });
            }

            // Auto Backup Logic
            setupAutoBackup() {
                // Clear any existing interval to prevent multiple intervals running
                if (this.autoBackupInterval) {
                    clearInterval(this.autoBackupInterval);
                    this.autoBackupInterval = null;
                }

                if (this.settings.autoBackup) {
                    // Perform an initial backup immediately upon setup
                    this.performAutoBackup();
                    // Set interval for 1 hour (3600000 milliseconds)
                    this.autoBackupInterval = setInterval(() => {
                        this.performAutoBackup();
                    }, 3600000); // 1 hour
                    this.addLog('info', 'Auto-backup scheduled to run every hour.');
                } else {
                    this.addLog('info', 'Auto-backup is disabled.');
                }
                this.updateLastAutoBackupTimestamp(); // Update timestamp display immediately
            }

            performAutoBackup() {
                // Call exportJsonData with false to prevent download prompt
                this.exportJsonData(false); 
            }

            updateLastAutoBackupTimestamp() {
                const timestampElement = document.getElementById('last-auto-backup-timestamp');
                if (timestampElement) {
                    timestampElement.textContent = this.settings.lastAutoBackup || 'Never';
                }
            }


            // Analytics (Chart.js integrations)
            updateAnalytics() {
                this.renderDepartmentSpendingTrendsChart();
                this.renderTonerConsumptionByDepartmentChart();
                this.renderMonthlyConsumptionTrendsChart();
                this.renderDepartmentWiseComparisonChart();
                this.renderPredictiveAnalysisChart();
                this.renderDepartmentAvgPurchaseValueChart();
                this.renderDepartmentPurchaseFrequencyChart();
                this.renderSupplierAvgUnitPriceChart();
                this.renderSupplierPerformanceOverview();
            }

            // Reports (Chart.js integrations for Reports tab)
            updateReports() {
                this.renderTonerModelUsageChart();
                this.renderSupplierSpendingDistributionChart();
                this.renderMonthlySpendingReportChart(); // Note: Renamed to avoid clash with CSV export
            }

            renderDepartmentSpendingTrendsChart() {
                const ctx = document.getElementById('departmentSpendingTrendsChart').getContext('2d');
                if (this.departmentSpendingTrendsChart) {
                    this.departmentSpendingTrendsChart.destroy();
                }

                const departmentSpending = {};
                this.tonerEntries.forEach(entry => {
                    const monthYear = new Date(entry.date).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    if (!departmentSpending[monthYear]) {
                        departmentSpending[monthYear] = {};
                    }
                    departmentSpending[monthYear][entry.department] = (departmentSpending[monthYear][entry.department] || 0) + parseFloat(entry.totalInclVat);
                });

                const labels = Object.keys(departmentSpending).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());
                const departments = Array.from(new Set(this.tonerEntries.map(entry => entry.department)));

                const datasets = departments.map(dept => {
                    return {
                        label: dept,
                        data: labels.map(label => departmentSpending[label][dept] || 0),
                        borderColor: this.getRandomColor(),
                        fill: false,
                        tension: 0.1
                    };
                });

                this.departmentSpendingTrendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Department Spending Trends Over Time'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month/Year'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Total Spending (AED)'
                                }
                            }
                        }
                    }
                });
            }

            renderTonerConsumptionByDepartmentChart() {
                const ctx = document.getElementById('tonerConsumptionByDepartmentChart').getContext('2d');
                if (this.tonerConsumptionByDepartmentChart) {
                    this.tonerConsumptionByDepartmentChart.destroy();
                }

                const departmentConsumption = {};
                this.tonerEntries.forEach(entry => {
                    departmentConsumption[entry.department] = (departmentConsumption[entry.department] || 0) + entry.quantity;
                });

                const labels = Object.keys(departmentConsumption);
                const data = Object.values(departmentConsumption);
                const backgroundColors = labels.map(() => this.getRandomColor());

                this.tonerConsumptionByDepartmentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Toner Quantity',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.2', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Toner Consumption by Department'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity (Units)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Department'
                                }
                            }
                        }
                    }
                });
            }

            renderMonthlyConsumptionTrendsChart() {
                const ctx = document.getElementById('monthlyConsumptionTrendsChart').getContext('2d');
                if (this.monthlyConsumptionTrendsChart) {
                    this.monthlyConsumptionTrendsChart.destroy();
                }

                const monthlyConsumption = {};
                this.tonerEntries.forEach(entry => {
                    const month = new Date(entry.date).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    monthlyConsumption[month] = (monthlyConsumption[month] || 0) + entry.quantity;
                });

                const labels = Object.keys(monthlyConsumption).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());
                const data = labels.map(label => monthlyConsumption[label]);

                this.monthlyConsumptionTrendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Toner Consumption',
                            data: data,
                            borderColor: var_primary_color,
                            backgroundColor: 'rgba(228, 0, 43, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Overall Monthly Toner Consumption'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity (Units)'
                                }
                            }
                        }
                    }
                });
            }

            renderDepartmentWiseComparisonChart() {
                const ctx = document.getElementById('departmentWiseComparisonChart').getContext('2d');
                if (this.departmentWiseComparisonChart) {
                    this.departmentWiseComparisonChart.destroy();
                }

                const departments = Array.from(new Set(this.tonerEntries.map(entry => entry.department)));
                const spendingData = departments.map(dept =>
                    this.tonerEntries
                        .filter(entry => entry.department === dept)
                        .reduce((sum, entry) => sum + parseFloat(entry.totalInclVat), 0)
                );
                const quantityData = departments.map(dept =>
                    this.tonerEntries
                        .filter(entry => entry.department === dept)
                        .reduce((sum, entry) => sum + entry.quantity, 0)
                );

                this.departmentWiseComparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: departments,
                        datasets: [
                            {
                                label: 'Total Spending (AED)',
                                data: spendingData,
                                backgroundColor: 'rgba(228, 0, 43, 0.7)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Total Quantity (Units)',
                                data: quantityData,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Department-wise Spending vs. Quantity'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Spending (AED)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Quantity (Units)'
                                }
                            }
                        }
                    }
                });
            }

            renderPredictiveAnalysisChart() {
                const ctx = document.getElementById('predictiveAnalysisChart').getContext('2d');
                if (this.predictiveAnalysisChart) {
                    this.predictiveAnalysisChart.destroy();
                }

                // Simple linear regression for demonstration
                const monthlyData = {};
                this.tonerEntries.forEach(entry => {
                    const month = new Date(entry.date).toISOString().substring(0, 7); //YYYY-MM
                    monthlyData[month] = (monthlyData[month] || 0) + entry.quantity;
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const historicalQuantities = sortedMonths.map(month => monthlyData[month]);

                if (sortedMonths.length < 2) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    return; // Not enough data for prediction
                }

                // Predict next 3 months (very basic linear extrapolation)
                const lastMonthIndex = sortedMonths.length - 1;
                const lastMonth = new Date(sortedMonths[lastMonthIndex] + '-01');
                
                const predictions = [];
                // Simplified: average of last two data points for trend
                let trend = 0;
                if (historicalQuantities.length >= 2) {
                    trend = (historicalQuantities[lastMonthIndex] - historicalQuantities[lastMonthIndex - 1]) / 1;
                } else if (historicalQuantities.length === 1) {
                    trend = historicalQuantities[0]; // if only one point, assume it's the trend
                }

                let lastValue = historicalQuantities[lastMonthIndex] || 0;

                for (let i = 1; i <= 3; i++) {
                    lastMonth.setMonth(lastMonth.getMonth() + 1);
                    const predictedMonth = lastMonth.toISOString().substring(0, 7);
                    const predictedValue = Math.max(0, lastValue + trend); // ensure quantity doesn't go negative
                    predictions.push({ month: predictedMonth, quantity: predictedValue });
                    lastValue = predictedValue;
                }

                const allLabels = [...sortedMonths, ...predictions.map(p => p.month)];
                const allData = [...historicalQuantities, ...predictions.map(p => p.quantity)];

                this.predictiveAnalysisChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allLabels,
                        datasets: [{
                            label: 'Historical Consumption',
                            data: historicalQuantities,
                            borderColor: var_primary_color,
                            backgroundColor: 'rgba(228, 0, 43, 0.2)',
                            fill: false,
                            tension: 0.3
                        }, {
                            label: 'Predicted Consumption',
                            data: Array(historicalQuantities.length - 1).fill(NaN).concat(historicalQuantities[historicalQuantities.length - 1], predictions.map(p => p.quantity)),
                            borderColor: 'rgba(0, 123, 255, 0.7)',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Future Toner Consumption Prediction'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity (Units)'
                                }
                            }
                        }
                    }
                });
            }

            renderDepartmentAvgPurchaseValueChart() {
                const ctx = document.getElementById('departmentAvgPurchaseValueChart').getContext('2d');
                if (this.departmentAvgPurchaseValueChart) {
                    this.departmentAvgPurchaseValueChart.destroy();
                }

                const deptPurchaseValues = {}; // { dept: { totalValue: 0, count: 0 } }

                this.tonerEntries.forEach(entry => {
                    if (!deptPurchaseValues[entry.department]) {
                        deptPurchaseValues[entry.department] = { totalValue: 0, count: 0 };
                    }
                    deptPurchaseValues[entry.department].totalValue += parseFloat(entry.totalInclVat);
                    deptPurchaseValues[entry.department].count++;
                });

                const labels = Object.keys(deptPurchaseValues);
                const data = labels.map(dept =>
                    deptPurchaseValues[dept].count > 0 ? (deptPurchaseValues[dept].totalValue / deptPurchaseValues[dept].count) : 0
                );
                const backgroundColors = labels.map(() => this.getRandomColor());

                this.departmentAvgPurchaseValueChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Purchase Value (AED)',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.2', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Departments with Highest Average Purchase Value'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Average Purchase Value (AED)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Department'
                                }
                            }
                        }
                    }
                });
            }

            renderDepartmentPurchaseFrequencyChart() {
                const ctx = document.getElementById('departmentPurchaseFrequencyChart').getContext('2d');
                if (this.departmentPurchaseFrequencyChart) {
                    this.departmentPurchaseFrequencyChart.destroy();
                }

                const departmentFrequency = {}; // { dept: count }

                this.tonerEntries.forEach(entry => {
                    departmentFrequency[entry.department] = (departmentFrequency[entry.department] || 0) + 1;
                });

                const labels = Object.keys(departmentFrequency);
                const data = Object.values(departmentFrequency);
                const backgroundColors = labels.map(() => this.getRandomColor());

                this.departmentPurchaseFrequencyChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Purchases',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Department Purchase Frequency'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' purchases';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderSupplierAvgUnitPriceChart() {
                const ctx = document.getElementById('supplierAvgUnitPriceChart').getContext('2d');
                if (this.supplierAvgUnitPriceChart) {
                    this.supplierAvgUnitPriceChart.destroy();
                }

                const supplierUnitPrices = {}; // { supplier: { totalUnitCost: 0, totalUnits: 0 } }

                this.tonerEntries.forEach(entry => {
                    if (!supplierUnitPrices[entry.supplier]) {
                        supplierUnitPrices[entry.supplier] = { totalUnitCost: 0, totalUnits: 0 };
                    }
                    supplierUnitPrices[entry.supplier].totalUnitCost += (entry.price * entry.quantity);
                    supplierUnitPrices[entry.supplier].totalUnits += entry.quantity;
                });

                const labels = Object.keys(supplierUnitPrices);
                const data = labels.map(supplier =>
                    supplierUnitPrices[supplier].totalUnits > 0 ? (supplierUnitPrices[supplier].totalUnitCost / supplierUnitPrices[supplier].totalUnits) : 0
                );
                const backgroundColors = labels.map(() => this.getRandomColor());

                this.supplierAvgUnitPriceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Unit Price (AED)',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.2', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Supplier Average Unit Price Comparison'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Average Unit Price (AED)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Supplier'
                                }
                            }
                        }
                    }
                });
            }

            renderSupplierPerformanceOverview() {
                const container = document.getElementById('supplier-performance-overview');
                container.innerHTML = '';

                const supplierPerformance = {};

                this.tonerEntries.forEach(entry => {
                    if (!supplierPerformance[entry.supplier]) {
                        supplierPerformance[entry.supplier] = { totalSpending: 0, totalQuantity: 0, distinctModels: new Set() };
                    }
                    supplierPerformance[entry.supplier].totalSpending += parseFloat(entry.totalInclVat);
                    supplierPerformance[entry.supplier].totalQuantity += entry.quantity;
                    supplierPerformance[entry.supplier].distinctModels.add(entry.tonerModel);
                });

                const sortedSuppliers = Object.entries(supplierPerformance).sort(([, a], [, b]) => b.totalSpending - a.totalSpending);

                if (sortedSuppliers.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No Supplier Data</h3><p>Add more entries to see supplier performance.</p></div>';
                    return;
                }

                sortedSuppliers.forEach(([supplierName, data]) => {
                    const card = document.createElement('div');
                    card.className = 'card department-card'; // Re-using department-card for consistent styling
                    card.innerHTML = `
                        <h3>${supplierName}</h3>
                        <div class="department-stats">
                            <div class="dept-stat">
                                <div class="dept-stat-value">AED ${data.totalSpending.toFixed(2)}</div>
                                <div class="dept-stat-label">Total Spending</div>
                            </div>
                            <div class="dept-stat">
                                <div class="dept-stat-value">${data.totalQuantity}</div>
                                <div class="dept-stat-label">Total Quantity</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4>Distinct Models:</h4>
                            <ul class="overview-list">
                                <li><span>Models Supplied:</span> <strong>${data.distinctModels.size}</strong></li>
                            </ul>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // New Report Charts
            renderTonerModelUsageChart() {
                const ctx = document.getElementById('tonerModelUsageChart').getContext('2d');
                if (this.tonerModelUsageChart) {
                    this.tonerModelUsageChart.destroy();
                }

                const modelData = {}; // { modelName: { quantity: 0, spending: 0 } }
                this.tonerEntries.forEach(entry => {
                    if (!modelData[entry.tonerModel]) {
                        modelData[entry.tonerModel] = { quantity: 0, spending: 0 };
                    }
                    modelData[entry.tonerModel].quantity += entry.quantity;
                    modelData[entry.tonerModel].spending += parseFloat(entry.totalInclVat);
                });

                const labels = Object.keys(modelData);
                const quantities = labels.map(model => modelData[model].quantity);
                const spending = labels.map(model => modelData[model].spending);

                this.tonerModelUsageChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Quantity Used',
                                data: quantities,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Total Spending (AED)',
                                data: spending,
                                backgroundColor: 'rgba(153, 102, 255, 0.7)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Toner Model Usage and Spending'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity (Units)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Spending (AED)'
                                }
                            }
                        }
                    }
                });
            }

            exportTonerModelUsageChartData() {
                const modelData = {};
                this.tonerEntries.forEach(entry => {
                    if (!modelData[entry.tonerModel]) {
                        modelData[entry.tonerModel] = { quantity: 0, spending: 0 };
                    }
                    modelData[entry.tonerModel].quantity += entry.quantity;
                    modelData[entry.tonerModel].spending += parseFloat(entry.totalInclVat);
                });

                const dataForExport = Object.keys(modelData).map(model => ({
                    'Toner Model': model,
                    'Quantity Used': modelData[model].quantity,
                    'Total Spending (AED)': parseFloat(modelData[model].spending).toFixed(2)
                }));
                this.exportArrayOfObjectsToXLSX(dataForExport, 'toner_model_usage_data.xlsx', 'Toner Model Usage');
            }

            renderSupplierSpendingDistributionChart() {
                const ctx = document.getElementById('supplierSpendingDistributionChart').getContext('2d');
                if (this.supplierSpendingDistributionChart) {
                    this.supplierSpendingDistributionChart.destroy();
                }

                const supplierSpending = {};
                this.tonerEntries.forEach(entry => {
                    supplierSpending[entry.supplier] = (supplierSpending[entry.supplier] || 0) + parseFloat(entry.totalInclVat);
                });

                const labels = Object.keys(supplierSpending);
                const data = Object.values(supplierSpending);
                const backgroundColors = labels.map(() => this.getRandomColor());

                this.supplierSpendingDistributionChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spending (AED)',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Supplier Spending Distribution'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += 'AED ' + context.parsed.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            exportSupplierSpendingDistributionChartData() {
                const supplierSpending = {};
                this.tonerEntries.forEach(entry => {
                    supplierSpending[entry.supplier] = (supplierSpending[entry.supplier] || 0) + parseFloat(entry.totalInclVat);
                });

                const dataForExport = Object.keys(supplierSpending).map(supplier => ({
                    'Supplier': supplier,
                    'Total Spending (AED)': parseFloat(supplierSpending[supplier]).toFixed(2)
                }));
                this.exportArrayOfObjectsToXLSX(dataForExport, 'supplier_spending_distribution_data.xlsx', 'Supplier Spending');
            }

            renderMonthlySpendingReportChart() {
                const ctx = document.getElementById('monthlySpendingChart').getContext('2d');
                if (this.monthlySpendingChart) {
                    this.monthlySpendingChart.destroy();
                }

                const monthlySpending = {};
                this.tonerEntries.forEach(entry => {
                    const month = new Date(entry.date).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    monthlySpending[month] = (monthlySpending[month] || 0) + parseFloat(entry.totalInclVat);
                });

                const labels = Object.keys(monthlySpending).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());
                const data = labels.map(label => monthlySpending[label]);

                this.monthlySpendingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Spending (AED)',
                            data: data,
                            borderColor: var_primary_color,
                            backgroundColor: 'rgba(228, 0, 43, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Monthly Total Spending Trends'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Total Spending (AED)'
                                }
                            }
                        }
                    }
                });
            }

            exportMonthlySpendingChartData() {
                const monthlySpending = {};
                this.tonerEntries.forEach(entry => {
                    const month = new Date(entry.date).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    monthlySpending[month] = (monthlySpending[month] || 0) + parseFloat(entry.totalInclVat);
                });

                const labels = Object.keys(monthlySpending).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());
                const dataForExport = labels.map(month => ({
                    'Month': month,
                    'Total Spending (AED)': parseFloat(monthlySpending[month]).toFixed(2)
                }));
                this.exportArrayOfObjectsToXLSX(dataForExport, 'monthly_spending_data.xlsx', 'Monthly Spending');
            }

            // Helper to export Chart.js canvas as PNG
            exportChartAsPNG(canvasId, filename) {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const image = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = image;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    this.addLog('report', `Exported chart: ${filename}`);
                    this.showAlert(`Chart "${filename}" exported successfully!`, 'success');
                } else {
                    this.showAlert('Error: Chart canvas not found.', 'error');
                }
            }

            // Generic helper to export an array of objects to XLSX
            exportArrayOfObjectsToXLSX(data, filename, sheetName = 'Sheet1') {
                try {
                    if (!data || data.length === 0) {
                        this.showAlert('No data to export to XLSX.', 'info');
                        return;
                    }
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31)); // Sheet name max 31 chars
                    XLSX.writeFile(wb, filename);
                    this.addLog('report', `Exported XLSX file: ${filename}`);
                    this.showAlert(`Data exported to XLSX successfully!`, 'success');
                } catch (error) {
                    this.showAlert('Error exporting data to XLSX: ' + error.message, 'error');
                    console.error('XLSX export error:', error);
                }
            }

            // Helper to generate random colors for charts
            getRandomColor() {
                const colors = [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)',
                    'rgba(199, 199, 199, 0.6)'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            // Offline/Online Indicator
            updateOnlineStatus() {
                const indicator = document.querySelector('.offline-indicator');
                // Check if indicator exists before trying to access its style property
                if (indicator) {
                    if (navigator.onLine) {
                        indicator.style.display = 'none';
                    } else {
                        indicator.style.display = 'block';
                    }
                }
            }

            applyInitialFilters() {
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) {
                    this.switchTab(tab);
                } else {
                    this.switchTab('add-entry'); // Default tab
                }

                // Check for department filter in URL
                const deptFilter = urlParams.get('department');
                if (deptFilter && document.getElementById('filter-all-department')) {
                    document.getElementById('filter-all-department').value = deptFilter;
                }
                // Check for search filter in URL
                const searchFilter = urlParams.get('search');
                if (searchFilter && document.getElementById('search-all-entries')) {
                    document.getElementById('search-all-entries').value = searchFilter;
                }
                this.filterAllEntries(); // Apply any initial filters
            }

            // New: Bulk Import Logic
            importBulkData(event, type) {
                const file = event.target.files[0];
                if (!file) {
                    this.showAlert('No file selected for import.', 'info');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let data;
                        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0]; // Assume data is on the first sheet
                            const worksheet = workbook.Sheets[sheetName];
                            data = XLSX.utils.sheet_to_json(worksheet);
                        } else if (file.name.endsWith('.csv')) {
                            data = this.parseCsv(e.target.result); // Custom CSV parser
                        } else {
                            this.showAlert('Unsupported file type. Please select a CSV or XLSX file.', 'error');
                            return;
                        }

                        if (type === 'entries') {
                            this.processImportedEntries(data);
                        } else if (type === 'departments') {
                            this.processImportedDepartments(data);
                        }
                        event.target.value = ''; // Clear file input for next import
                    } catch (error) {
                        this.showAlert(`Error processing file: ${error.message}`, 'error');
                        console.error('Bulk import error:', error);
                    }
                };

                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.readAsBinaryString(file);
                } else {
                    reader.readAsText(file);
                }
            }

            // Helper to parse CSV data, handling commas within quoted fields
            parseCsv(csvString) {
                const lines = csvString.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) return [];

                // Simple header parsing, assuming first line is header
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const result = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCsvLine(lines[i]); // Custom helper to handle quoted fields
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed CSV row (header/value count mismatch): ${lines[i]}`);
                        continue;
                    }
                    const row = {};
                    for (let j = 0; j < headers.length; j++) {
                        row[headers[j]] = values[j];
                    }
                    result.push(row);
                }
                return result;
            }

            // Helper to parse a single CSV line, correctly handling quoted fields
            parseCsvLine(line) {
                const result = [];
                let inQuote = false;
                let currentField = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        // Handle escaped quotes ""
                        if (inQuote && i + 1 < line.length && line[i+1] === '"') {
                            currentField += '"';
                            i++; // Skip the next quote
                        } else {
                            inQuote = !inQuote;
                        }
                    } else if (char === ',' && !inQuote) {
                        result.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField.trim()); // Add the last field
                return result;
            }

            processImportedEntries(data) {
                let importedCount = 0;
                let skippedCount = 0;
                const newEntries = [];

                data.forEach(row => {
                    // Normalize keys to expected format (case-insensitive and common variations)
                    const department = row['Department'] || row['department'] || '';
                    const tonerModel = row['Toner Model'] || row['tonerModel'] || '';
                    const date = row['Date'] || row['date'] || '';
                    const invoice = row['Invoice Number'] || row['invoice'] || '';
                    const supplier = row['Supplier Name'] || row['supplier'] || '';
                    const price = parseFloat(row['Unit Price (AED)'] || row['Unit Price'] || row['price']);
                    const quantity = parseInt(row['Quantity'] || row['quantity']);
                    const comments = row['Comments'] || row['comments'] || '';

                    // Basic validation for required fields and valid numbers
                    if (!department || !tonerModel || !date || !invoice || !supplier || isNaN(price) || isNaN(quantity) || price <= 0 || quantity <= 0) {
                        skippedCount++;
                        this.addLog('error', `Skipped invalid entry during bulk import: Missing or invalid required fields. Row: ${JSON.stringify(row)}`);
                        return;
                    }

                    // Validate date format (YYYY-MM-DD)
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(date) || isNaN(new Date(date).getTime())) {
                        skippedCount++;
                        this.addLog('error', `Skipped entry due to invalid date format (expectedYYYY-MM-DD): ${date}. Row: ${JSON.stringify(row)}`);
                        return;
                    }

                    // Check for duplicate invoice numbers combined with department and toner model for uniqueness
                    if (this.tonerEntries.some(e => 
                        e.invoice === invoice && 
                        e.department === department && 
                        e.tonerModel === tonerModel &&
                        e.date === date // Include date for more robust uniqueness
                    )) {
                        skippedCount++;
                        this.addLog('info', `Skipped duplicate entry during bulk import: Invoice ${invoice} for ${tonerModel} in ${department} on ${date} already exists.`);
                        return;
                    }

                    const vatRate = this.settings.vatRate / 100;
                    const totalCost = price * quantity;
                    const vatAmount = totalCost * vatRate;
                    const totalInclVat = totalCost + vatAmount;

                    newEntries.push({
                        id: Date.now() + Math.random(), // Unique ID for each entry
                        department: department,
                        tonerModel: tonerModel,
                        date: date,
                        invoice: invoice,
                        supplier: supplier,
                        price: price,
                        quantity: quantity,
                        totalCost: totalCost.toFixed(2),
                        vatAmount: vatAmount.toFixed(2),
                        totalInclVat: totalInclVat.toFixed(2),
                        comments: comments
                    });
                    importedCount++;
                });

                if (newEntries.length > 0) {
                    this.tonerEntries.unshift(...newEntries); // Add to the beginning for recent view
                    this.saveEntries();
                    this.renderAllContent();
                    this.addLog('restore', `Bulk imported ${importedCount} toner entries. Skipped ${skippedCount} invalid/duplicate entries.`);
                    this.showAlert(`Successfully imported ${importedCount} entries. ${skippedCount} skipped.`, 'success');
                } else {
                    this.showAlert(`No valid entries found in the file to import. Skipped ${skippedCount} entries.`, 'info');
                }
            }

            processImportedDepartments(data) {
                let importedCount = 0;
                let skippedCount = 0;
                const newDepartments = [];

                data.forEach(row => {
                    const deptName = (row['Department Name'] || row['departmentName'] || '').trim();
                    const defaultModels = (row['Default Toner Model(s)'] || row['defaultTonerModel'] || '').trim();

                    if (!deptName) {
                        skippedCount++;
                        this.addLog('error', `Skipped invalid department during bulk import: Missing department name. Row: ${JSON.stringify(row)}`);
                        return;
                    }

                    if (this.departments.some(d => d.name.toLowerCase() === deptName.toLowerCase())) {
                        skippedCount++;
                        this.addLog('info', `Skipped duplicate department during bulk import: ${deptName} already exists.`);
                        return;
                    }

                    newDepartments.push({
                        id: Date.now() + Math.random(), // Unique ID
                        name: deptName,
                        defaultModels: defaultModels
                    });
                    importedCount++;
                });

                if (newDepartments.length > 0) {
                    this.departments.push(...newDepartments);
                    this.saveDepartments();
                    this.renderAllContent();
                    this.addLog('restore', `Bulk imported ${importedCount} departments. Skipped ${skippedCount} invalid/duplicate departments.`);
                    this.showAlert(`Successfully imported ${importedCount} departments. ${skippedCount} skipped.`, 'success');
                } else {
                    this.showAlert(`No valid departments found in the file to import. Skipped ${skippedCount} departments.`, 'info');
                }
            }

            // Sample data generation methods
            downloadSampleEntriesCsv() {
                const sampleData = [
                    ["Department", "Toner Model", "Date", "Invoice Number", "Supplier Name", "Unit Price (AED)", "Quantity", "Comments"],
                    ["IT Department", "TN-3417", "2023-01-15", "INV-2023-001", "Ivory Computers", "120.50", "2", "Urgent purchase for server room printer"],
                    ["HR Department", "CK-4520", "2023-01-20", "INV-2023-002", "Starlink", "95.00", "1", "For new employee's printer"],
                    ["Finance", "TN 2305", "2023-02-01", "INV-2023-003", "SSIT", "110.25", "3", "Monthly stock refill"],
                    ["Marketing", "147A(W1470A)", "2023-02-10", "INV-2023-004", "Ivory Computers", "150.00", "1", "High-yield toner for graphic design printer"]
                ];
                // Ensure fields are quoted and internal quotes are escaped
                const csvContent = sampleData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                this.downloadFile(csvContent, 'sample_toner_entries.csv', 'text/csv');
                this.addLog('info', 'Downloaded sample toner entries CSV.');
                this.showAlert('Sample entries CSV downloaded!', 'info');
            }

            downloadSampleEntriesXLSX() {
                const sampleData = [
                    {
                        "Department": "IT Department",
                        "Toner Model": "TN-3417",
                        "Date": "2023-01-15",
                        "Invoice Number": "INV-2023-001",
                        "Supplier Name": "Ivory Computers",
                        "Unit Price (AED)": 120.50,
                        "Quantity": 2,
                        "Comments": "Urgent purchase for server room printer"
                    },
                    {
                        "Department": "HR Department",
                        "Toner Model": "CK-4520",
                        "Date": "2023-01-20",
                        "Invoice Number": "INV-2023-002",
                        "Supplier Name": "Starlink",
                        "Unit Price (AED)": 95.00,
                        "Quantity": 1,
                        "Comments": "For new employee's printer"
                    },
                    {
                        "Department": "Finance",
                        "Toner Model": "TN 2305",
                        "Date": "2023-02-01",
                        "Invoice Number": "INV-2023-003",
                        "Supplier Name": "SSIT",
                        "Unit Price (AED)": 110.25,
                        "Quantity": 3,
                        "Comments": "Monthly stock refill"
                    },
                    {
                        "Department": "Marketing",
                        "Toner Model": "147A(W1470A)",
                        "Date": "2023-02-10",
                        "Invoice Number": "INV-2023-004",
                        "Supplier Name": "Ivory Computers",
                        "Unit Price (AED)": 150.00,
                        "Quantity": 1,
                        "Comments": "High-yield toner for graphic design printer"
                    }
                ];
                this.exportArrayOfObjectsToXLSX(sampleData, 'sample_toner_entries.xlsx', 'Sample Entries');
                this.addLog('info', 'Downloaded sample toner entries XLSX.');
            }

            downloadSampleDepartmentsCsv() {
                const sampleData = [
                    ["Department Name", "Default Toner Model(s)"],
                    ["Sales", "TN-3417"],
                    ["Customer Service", "CK-4520, TN 2305"],
                    ["Logistics", "TN 2405"]
                ];
                // Ensure fields are quoted and internal quotes are escaped
                const csvContent = sampleData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                this.downloadFile(csvContent, 'sample_departments.csv', 'text/csv');
                this.addLog('info', 'Downloaded sample departments CSV.');
                this.showAlert('Sample departments CSV downloaded!', 'info');
            }

            downloadSampleDepartmentsXLSX() {
                const sampleData = [
                    {
                        "Department Name": "Sales",
                        "Default Toner Model(s)": "TN-3417"
                    },
                    {
                        "Department Name": "Customer Service",
                        "Default Toner Model(s)": "CK-4520, TN 2305"
                    },
                    {
                        "Department Name": "Logistics",
                        "Default Toner Model(s)": "TN 2405"
                    }
                ];
                this.exportArrayOfObjectsToXLSX(sampleData, 'sample_departments.xlsx', 'Sample Departments');
                this.addLog('info', 'Downloaded sample departments XLSX.');
            }
        }

        // Initialize the app - MUST be done after TonerApp class is defined
        // Wait for the DOM to be fully loaded before initializing the app
        document.addEventListener('DOMContentLoaded', () => {
            tonerApp = new TonerApp(); // Assign to the globally declared variable

            // Ensure offline indicator works
            window.addEventListener('online', tonerApp.updateOnlineStatus);
            window.addEventListener('offline', tonerApp.updateOnlineStatus);
            tonerApp.updateOnlineStatus(); // Set initial status
        });
    </script>
</body>
</html>
